<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CareerVest Resume Match | AI-Powered Resume Optimization</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- PDF.js for client-side PDF rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- mammoth.js for client-side DOCX to HTML conversion -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* CareerVest Brand Colors - Maroon, Yellow, White */
            --primary: #682A53;
            --primary-dark: #4d1f3d;
            --primary-light: #8a3a6d;
            --accent: #FDC500;
            --accent-dark: #d4a500;
            --accent-light: #ffd633;
            --success: #10b981;
            --warning: #FDC500;
            --danger: #ef4444;
            --bg: #0a0a0a;
            --bg-gradient: linear-gradient(135deg, #0a0a0a 0%, #1a0f15 30%, #2a1a25 100%);
            --bg-card: rgba(255, 255, 255, 0.05);
            --bg-card-hover: rgba(255, 255, 255, 0.08);
            --bg-glass: rgba(104, 42, 83, 0.15);
            --text: #ffffff;
            --text-muted: #e8e8e8;
            --text-secondary: #c5c5c5;
            --text-light: #d0d0d0;
            --border: rgba(104, 42, 83, 0.4);
            --border-light: rgba(253, 197, 0, 0.3);
            --shadow: 0 20px 25px -5px rgba(104, 42, 83, 0.3);
            --shadow-lg: 0 25px 50px -12px rgba(104, 42, 83, 0.4);
            --shadow-yellow: 0 10px 30px rgba(253, 197, 0, 0.3);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 50%, rgba(104, 42, 83, 0.2) 0%, transparent 60%),
                radial-gradient(circle at 80% 80%, rgba(253, 197, 0, 0.15) 0%, transparent 60%),
                radial-gradient(circle at 50% 20%, rgba(255, 255, 255, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem 0;
            animation: fadeInDown 0.6s ease-out;
        }

        .header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 0.25rem;
        }

        .careervest-logo {
            display: flex;
            align-items: center;
            gap: 0.875rem;
        }

        .logo-icon {
            width: 75px;
            height: 75px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 0 20px rgba(253, 197, 0, 0.6));
        }

        .logo-text {
            display: flex;
            flex-direction: column;
            line-height: 1.1;
            justify-content: center;
        }

        .logo-text .career {
            font-size: 2.4rem;
            font-weight: 800;
            color: #ffffff;
            letter-spacing: 0.08em;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .logo-text .vest {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffffff;
            letter-spacing: 0.12em;
            margin-top: -0.2rem;
            margin-left: 0.1em;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            font-weight: 700;
            background: linear-gradient(135deg, #682A53 0%, #8a3a6d 50%, #ffffff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            letter-spacing: -0.01em;
            text-align: center;
        }

        .header p {
            color: var(--text-muted);
            font-size: 1.2rem;
            font-weight: 400;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            animation: fadeInUp 0.8s ease-out;
        }

        .card {
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 28px;
            padding: 2rem 2.25rem;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow:
                0 10px 30px -5px rgba(104, 42, 83, 0.3),
                0 4px 12px -2px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, rgba(253, 197, 0, 0.5), transparent);
            border-radius: 28px 28px 0 0;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .card:hover::before {
            opacity: 1;
        }

        .card:hover {
            transform: translateY(-6px);
            box-shadow:
                0 20px 45px -5px rgba(104, 42, 83, 0.4),
                0 12px 24px -2px rgba(253, 197, 0, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.15),
                0 0 30px rgba(253, 197, 0, 0.15);
            border-color: rgba(253, 197, 0, 0.6);
            background: rgba(255, 255, 255, 0.09);
        }

        .card h2 {
            font-size: 1.85rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1.25rem;
            font-weight: 700;
            color: var(--text);
            letter-spacing: -0.01em;
        }

        .card h2 i {
            color: var(--accent);
            font-size: 1.6rem;
            text-shadow: 0 0 15px rgba(253, 197, 0, 0.6);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                filter: brightness(1);
            }

            50% {
                transform: scale(1.05);
                filter: brightness(1.2);
            }
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--text);
            font-size: 1rem;
            letter-spacing: 0.01em;
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: var(--bg-glass);
            margin-bottom: 1rem;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--accent);
            background: rgba(253, 197, 0, 0.12);
            box-shadow:
                0 8px 24px rgba(253, 197, 0, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transform: scale(1.01);
        }

        .btn {
            padding: 1.125rem 2.5rem;
            border: none;
            border-radius: 16px;
            font-size: 1.05rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.875rem;
            position: relative;
            overflow: hidden;
            text-transform: none;
            letter-spacing: 0.02em;
            min-width: 200px;
            box-shadow: 0 4px 14px 0 rgba(0, 0, 0, 0.3);
        }

        .btn i {
            font-size: 1.15rem;
            transition: transform 0.3s ease;
        }

        .btn:hover i {
            transform: scale(1.15) rotate(5deg);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
            transition: left 0.6s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 16px;
            padding: 2px;
            background: linear-gradient(135deg, rgba(253, 197, 0, 0.4), transparent, rgba(255, 255, 255, 0.2));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .btn:hover::after {
            opacity: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, #682A53 0%, #8a3a6d 50%, #682A53 100%);
            background-size: 200% 100%;
            background-position: 0% 50%;
            color: #ffffff;
            box-shadow:
                0 8px 24px rgba(104, 42, 83, 0.5),
                0 4px 12px rgba(253, 197, 0, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(253, 197, 0, 0.4);
            position: relative;
        }

        .btn-primary::before {
            background: linear-gradient(90deg, transparent, rgba(253, 197, 0, 0.3), transparent);
        }

        .btn-primary:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow:
                0 14px 40px rgba(104, 42, 83, 0.65),
                0 8px 20px rgba(253, 197, 0, 0.4),
                inset 0 2px 0 rgba(255, 255, 255, 0.2),
                0 0 30px rgba(253, 197, 0, 0.3);
            border-color: var(--accent);
            background-position: 100% 50%;
        }

        .btn-primary:active {
            transform: translateY(-2px) scale(0.98);
            box-shadow:
                0 4px 16px rgba(104, 42, 83, 0.6),
                0 2px 8px rgba(253, 197, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .btn-download {
            background: linear-gradient(135deg, #682A53 0%, #8a3a6d 50%, #682A53 100%);
            background-size: 200% 100%;
            background-position: 0% 50%;
            color: #ffffff;
            padding: 1rem 2.25rem;
            font-size: 1rem;
            font-weight: 800;
            box-shadow:
                0 8px 24px rgba(104, 42, 83, 0.5),
                0 4px 12px rgba(253, 197, 0, 0.25),
                inset 0 2px 0 rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(253, 197, 0, 0.4);
            text-shadow: none;
        }

        .btn-download::before {
            background: linear-gradient(90deg, transparent, rgba(253, 197, 0, 0.3), transparent);
        }

        .btn-download:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow:
                0 14px 40px rgba(104, 42, 83, 0.65),
                0 8px 20px rgba(253, 197, 0, 0.4),
                inset 0 2px 0 rgba(255, 255, 255, 0.2),
                0 0 30px rgba(253, 197, 0, 0.3);
            background-position: 100% 50%;
            border-color: var(--accent);
        }

        .btn-download:active {
            transform: translateY(-2px) scale(0.98);
        }

        .btn-upload {
            background: linear-gradient(135deg, #682A53 0%, #8a3a6d 50%, #682A53 100%);
            background-size: 200% 100%;
            background-position: 0% 50%;
            color: #ffffff;
            border: 2px solid rgba(253, 197, 0, 0.4);
            padding: 1rem 2.25rem;
            font-size: 1rem;
            font-weight: 600;
            box-shadow:
                0 8px 24px rgba(104, 42, 83, 0.5),
                0 4px 12px rgba(253, 197, 0, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }

        .btn-upload::before {
            background: linear-gradient(90deg, transparent, rgba(253, 197, 0, 0.3), transparent);
        }

        .btn-upload:hover {
            background: linear-gradient(135deg, #682A53 0%, #8a3a6d 50%, #682A53 100%);
            background-position: 100% 50%;
            border-color: var(--accent);
            color: #ffffff;
            box-shadow:
                0 14px 40px rgba(104, 42, 83, 0.65),
                0 8px 20px rgba(253, 197, 0, 0.4),
                inset 0 2px 0 rgba(255, 255, 255, 0.2),
                0 0 30px rgba(253, 197, 0, 0.3);
            transform: translateY(-3px) scale(1.01);
        }

        .btn-upload:active {
            transform: translateY(-1px) scale(0.99);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
        }

        .btn:disabled::before,
        .btn:disabled::after {
            display: none;
        }

        .btn:disabled i {
            transform: none !important;
        }

        textarea {
            width: 100%;
            padding: 1.25rem 1.5rem;
            background: rgba(255, 255, 255, 0.06);
            border: 2px solid rgba(104, 42, 83, 0.3);
            border-radius: 16px;
            color: var(--text);
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
            min-height: 200px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            line-height: 1.8;
            box-shadow:
                inset 0 2px 6px rgba(0, 0, 0, 0.15),
                0 2px 8px rgba(104, 42, 83, 0.1);
        }

        textarea:hover {
            border-color: rgba(104, 42, 83, 0.5);
            background: rgba(255, 255, 255, 0.08);
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow:
                0 0 0 4px rgba(253, 197, 0, 0.25),
                0 4px 20px rgba(253, 197, 0, 0.15),
                inset 0 2px 6px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.005);
        }

        textarea::placeholder {
            color: #d0d0d0;
            opacity: 1;
        }

        .btn-center {
            text-align: center;
            margin: 2.5rem 0;
        }

        /* Premium Loading Overlay */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
        }

        .loading.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        .loading-content {
            text-align: center;
            max-width: 500px;
            padding: 3rem;
            animation: slideUp 0.5s ease-out;
        }

        /* Logo Animation */
        .loading-logo {
            margin-bottom: 2rem;
        }

        .loading-logo img {
            height: 100px;
            width: auto;
            filter: drop-shadow(0 0 30px rgba(253, 197, 0, 0.8));
        }

        .pulse-animation {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                filter: drop-shadow(0 0 30px rgba(253, 197, 0, 0.8));
            }
            50% {
                transform: scale(1.05);
                filter: drop-shadow(0 0 40px rgba(253, 197, 0, 1));
            }
        }

        /* Loading Dots */
        .loading-dots {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin: 2rem 0;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent);
            animation: bounce 1.4s infinite ease-in-out both;
            box-shadow: 0 0 20px rgba(253, 197, 0, 0.6);
        }

        .dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Loading Message */
        .loading-message {
            margin: 2rem 0;
        }

        .loading-message h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #682A53 0%, #8a3a6d 50%, #ffffff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmer 3s ease-in-out infinite;
            transition: opacity 0.3s ease-in-out;
        }

        .loading-message p {
            font-size: 1.1rem;
            color: var(--text-muted);
            line-height: 1.6;
            animation: fadeInOut 3s ease-in-out infinite;
            transition: opacity 0.3s ease-in-out;
        }

        @keyframes shimmer {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        @keyframes fadeInOut {
            0%, 100% {
                opacity: 0.7;
            }
            50% {
                opacity: 1;
            }
        }

        /* Progress Bar */
        .loading-progress {
            margin-top: 2rem;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #682A53, #8a3a6d, #682A53);
            background-size: 200% 100%;
            animation: progressSlide 2s ease-in-out infinite;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(104, 42, 83, 0.6);
        }

        @keyframes progressSlide {
            0% {
                background-position: 0% 0%;
            }
            100% {
                background-position: 200% 0%;
            }
        }

        /* Multi-Stage Progress Indicator */
        .progress-stages {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            gap: 0.5rem;
        }

        .progress-stage {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            opacity: 0.4;
            transition: all 0.3s ease;
        }

        .progress-stage.active {
            opacity: 1;
        }

        .progress-stage.completed {
            opacity: 1;
        }

        .progress-stage .stage-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(253, 197, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--text-muted);
            transition: all 0.3s ease;
        }

        .progress-stage.active .stage-icon {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg);
            box-shadow: 0 0 20px rgba(253, 197, 0, 0.6);
            animation: pulse 2s ease-in-out infinite;
        }

        .progress-stage.completed .stage-icon {
            background: var(--primary);
            border-color: var(--primary);
            color: #ffffff;
        }

        .progress-stage .stage-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        .progress-stage.active .stage-label {
            color: var(--accent);
        }

        .progress-stage.completed .stage-label {
            color: var(--primary-light);
        }

        .progress-stage .stage-status {
            font-size: 0.7rem;
            color: var(--text-light);
            font-weight: 500;
        }

        .progress-stage.active .stage-status {
            color: var(--accent-light);
        }

        .progress-stage.completed .stage-status {
            color: var(--success);
        }

        .progress-connector {
            width: 40px;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .progress-connector.completed {
            background: var(--primary);
        }

        .progress-percentage {
            text-align: center;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--accent);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #682A53, #8a3a6d);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(104, 42, 83, 0.6);
            transition: width 0.3s ease;
            width: 0%;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message {
            padding: 1.5rem 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            display: none;
            animation: slideIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-weight: 600;
            font-size: 1.05rem;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            border-width: 2px;
            border-style: solid;
            position: relative;
            overflow: hidden;
        }

        .message::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            background: currentColor;
            opacity: 0.8;
        }

        .message.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-30px) translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0) translateY(0);
            }
        }

        .message-success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.18) 0%, rgba(16, 185, 129, 0.12) 100%);
            border-color: var(--success);
            color: var(--success);
        }

        .message-error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.18) 0%, rgba(239, 68, 68, 0.12) 100%);
            border-color: var(--danger);
            color: var(--danger);
        }

        .results-section {
            margin-top: 2rem;
            animation: fadeInUp 0.6s ease-out;
        }

        .match-score-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 3rem 2rem;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .match-score-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #682A53, #8a3a6d, #ffffff);
            box-shadow: 0 0 10px rgba(104, 42, 83, 0.5);
        }

        .score-circle {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto 2rem;
            font-size: 3rem;
            font-weight: 800;
            position: relative;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .score-circle::after {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            padding: 4px;
            background: linear-gradient(135deg, transparent, rgba(255, 255, 255, 0.1));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
        }

        .score-high {
            background: linear-gradient(135deg, #682A53 0%, #8a3a6d 50%, #682A53 100%);
            color: #ffffff;
            box-shadow: 0 0 30px rgba(104, 42, 83, 0.5);
        }

        .score-medium {
            background: linear-gradient(135deg, #8a3a6d 0%, #682A53 100%);
            color: #ffffff;
            box-shadow: 0 0 20px rgba(104, 42, 83, 0.5);
        }

        .score-low {
            background: linear-gradient(135deg, #682A53 0%, #4d1f3d 100%);
            color: #ffffff;
            box-shadow: 0 0 20px rgba(104, 42, 83, 0.4);
        }

        #score-value {
            font-size: 3.5rem;
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        #score-message {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
        }

        #score-description {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .analysis-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 1.75rem;
            margin-bottom: 1.25rem;
            transition: all 0.3s;
            box-shadow: var(--shadow);
        }

        .analysis-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .analysis-card h3 {
            font-size: 1.5rem;
            margin-bottom: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 700;
        }

        .analysis-card h3 i {
            font-size: 1.25rem;
        }

        .analysis-card h3 i[style*="success"] {
            color: var(--accent) !important;
            text-shadow: 0 0 10px rgba(253, 197, 0, 0.5);
        }

        .analysis-card h3 i[style*="warning"] {
            color: var(--accent) !important;
        }

        .analysis-card h3 i[style*="primary"] {
            color: var(--accent) !important;
            text-shadow: 0 0 10px rgba(253, 197, 0, 0.5);
        }

        .strengths-list,
        .improvements-list,
        .suggestions-list {
            list-style: none;
        }

        .strengths-list li,
        .improvements-list li {
            padding: 1rem 1.25rem;
            margin-bottom: 0.75rem;
            border-radius: 12px;
            display: flex;
            align-items: start;
            gap: 1rem;
            transition: all 0.2s;
        }

        .strengths-list li:hover,
        .improvements-list li:hover {
            transform: translateX(4px);
        }

        .strengths-list li {
            background: rgba(253, 197, 0, 0.15);
            border-left: 4px solid var(--accent);
        }

        .strengths-list li i {
            color: var(--accent);
            margin-top: 0.25rem;
            text-shadow: 0 0 8px rgba(253, 197, 0, 0.5);
        }

        .improvements-list li {
            background: rgba(104, 42, 83, 0.2);
            border-left: 4px solid var(--primary);
        }

        .improvements-list li i {
            color: var(--primary-light);
            margin-top: 0.25rem;
        }

        .suggestions-list li {
            padding: 1.75rem 2rem;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, rgba(104, 42, 83, 0.18) 0%, rgba(104, 42, 83, 0.12) 100%);
            border-radius: 16px;
            border-left: 5px solid var(--accent);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            line-height: 1.8;
            box-shadow:
                0 4px 12px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .suggestions-list li::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(180deg, var(--accent), rgba(253, 197, 0, 0.3));
            transition: width 0.3s ease;
        }

        .suggestions-list li:hover::before {
            width: 8px;
        }

        .suggestions-list li:hover {
            background: linear-gradient(135deg, rgba(104, 42, 83, 0.25) 0%, rgba(104, 42, 83, 0.18) 100%);
            transform: translateX(6px) scale(1.01);
            box-shadow:
                0 8px 24px rgba(253, 197, 0, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.15),
                0 0 20px rgba(253, 197, 0, 0.15);
            border-left-color: rgba(253, 197, 0, 0.9);
        }

        /* Enhanced suggestion content styling */
        .suggestions-list li strong {
            color: var(--accent);
            font-weight: 700;
            text-shadow: 0 0 8px rgba(253, 197, 0, 0.3);
        }

        /* ==== Hybrid Dashboard Styles ==== */

        /* Dashboard Score Card */
        .dashboard-score-card {
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 1.75rem 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 12px 36px -8px rgba(104, 42, 83, 0.3);
        }

        .score-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1.25rem;
        }

        .score-main {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .score-info h2 {
            margin: 0 0 0.5rem 0;
            font-size: 1.75rem;
            color: var(--text);
        }

        .score-info p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .score-potential {
            text-align: right;
        }

        .potential-badge {
            background: linear-gradient(135deg, rgba(253, 197, 0, 0.2), rgba(253, 197, 0, 0.1));
            border: 2px solid var(--accent);
            border-radius: 16px;
            padding: 1rem 1.5rem;
            display: inline-block;
        }

        .potential-label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .potential-value {
            display: block;
            font-size: 2rem;
            font-weight: 800;
            color: var(--accent);
            text-shadow: 0 0 15px rgba(253, 197, 0, 0.5);
        }

        /* Score Breakdown */
        .score-breakdown {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px dashed var(--border);
        }

        .score-breakdown h3 {
            margin: 0 0 1rem 0;
            font-size: 1rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .score-breakdown h3 i {
            color: var(--accent);
            font-size: 0.9rem;
        }

        .breakdown-items {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .breakdown-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.65rem 0.85rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .breakdown-item.status-good {
            border-left-color: var(--success);
        }

        .breakdown-item.status-warning {
            border-left-color: var(--warning);
        }

        .breakdown-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(4px);
        }

        .breakdown-item-left {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            flex: 1;
        }

        .breakdown-item-icon {
            font-size: 0.95rem;
        }

        .breakdown-item-name {
            font-weight: 600;
            color: var(--text);
            font-size: 0.9rem;
        }

        .breakdown-item-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .breakdown-score {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text);
        }

        .breakdown-gain {
            font-size: 0.8rem;
            color: var(--accent);
            font-weight: 600;
        }

        .breakdown-footer {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px dashed rgba(255, 255, 255, 0.1);
        }

        .breakdown-footer p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .breakdown-footer i {
            color: var(--accent);
        }

        /* Actions Dashboard */
        .actions-dashboard {
            margin-bottom: 2rem;
        }

        .dashboard-title {
            font-size: 1.85rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--text);
        }

        .dashboard-title i {
            color: var(--accent);
            font-size: 1.6rem;
        }

        .priority-section {
            margin-bottom: 2rem;
        }

        .priority-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        .critical-header {
            background: linear-gradient(135deg, rgba(255, 77, 77, 0.15), rgba(255, 77, 77, 0.05));
            border-left: 5px solid #ff4d4d;
        }

        .high-impact-header {
            background: linear-gradient(135deg, rgba(253, 197, 0, 0.15), rgba(253, 197, 0, 0.05));
            border-left: 5px solid var(--accent);
        }

        .polish-header {
            background: linear-gradient(135deg, rgba(76, 217, 100, 0.15), rgba(76, 217, 100, 0.05));
            border-left: 5px solid #4cd964;
        }

        .priority-icon {
            font-size: 1.5rem;
        }

        .priority-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--text);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
        }

        .actions-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .action-item {
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .action-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(253, 197, 0, 0.2);
            border-color: var(--accent);
        }

        .action-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1rem;
        }

        .action-title {
            flex: 1;
            font-size: 1.05rem;
            color: var(--text);
            line-height: 1.5;
        }

        .action-meta {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            white-space: nowrap;
        }

        .action-points {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--accent);
            text-shadow: 0 0 10px rgba(253, 197, 0, 0.4);
        }

        .action-time {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.4);
            display: flex;
            align-items: center;
            gap: 0.3rem;
            opacity: 0.7;
        }

        .action-time i {
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.7rem;
        }

        .action-item:hover .action-time {
            opacity: 1;
            color: var(--text-secondary);
        }

        /* Collapsible Strengths */
        .strengths-collapsible {
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 16px;
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .collapsible-header {
            width: 100%;
            padding: 1.5rem;
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
        }

        .collapsible-header:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .collapsible-header span {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .collapsible-header i {
            transition: transform 0.3s ease;
        }

        .collapsible-header.expanded i {
            transform: rotate(180deg);
        }

        .collapsible-content {
            padding: 0 1.5rem 1.5rem 1.5rem;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .strengths-footer {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .strengths-footer i {
            color: var(--success);
        }

        /* Export Preview Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            position: relative;
            background: linear-gradient(135deg, #1a0f15 0%, #0a0a0a 100%);
            border-radius: 20px;
            border: 2px solid rgba(104, 42, 83, 0.5);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.8), 0 0 40px rgba(253, 197, 0, 0.2);
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.4s ease-out;
            z-index: 10001;
        }

        .modal-header {
            padding: 2rem 2.5rem 1.5rem;
            border-bottom: 2px solid rgba(104, 42, 83, 0.4);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--text);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-header h2 i {
            color: var(--accent);
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

        .modal-close:hover {
            background: var(--danger);
            border-color: var(--danger);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 2rem 2.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .preview-info {
            margin-bottom: 1.5rem;
        }

        .info-badge {
            background: linear-gradient(135deg, rgba(104, 42, 83, 0.2) 0%, rgba(253, 197, 0, 0.1) 100%);
            border: 1px solid rgba(253, 197, 0, 0.3);
            border-radius: 10px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--text-muted);
        }

        .info-badge i {
            color: var(--accent);
            font-size: 1.2rem;
        }

        .preview-container {
            background: #ffffff;
            border-radius: 12px;
            padding: 2rem;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .export-preview-display {
            font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;
            font-size: 10pt;
            line-height: 1.3;
            color: #1a1a1a;
        }

        .modal-footer {
            padding: 1.5rem 2.5rem 2rem;
            border-top: 2px solid rgba(104, 42, 83, 0.4);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* Analytics & Insights Styles */
        .analytics-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid rgba(104, 42, 83, 0.2);
            flex-wrap: wrap;
        }

        .analytics-tab {
            padding: 0.75rem 1.25rem;
            background: transparent;
            border: none;
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .analytics-tab:hover {
            background: rgba(104, 42, 83, 0.1);
            color: var(--primary);
        }

        .analytics-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }

        .analytics-tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .analytics-tab-content.active {
            display: block;
        }

        /* Collapsible section styles */
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .collapsible-header:hover {
            opacity: 0.8;
        }

        .collapsible-header .toggle-icon {
            transition: transform 0.3s ease;
            margin-left: 0.5rem;
            font-size: 0.9em;
        }

        .collapsible-header .toggle-icon.expanded {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0;
        }

        .collapsible-content.expanded {
            max-height: 5000px;
            opacity: 1;
            transition: max-height 0.5s ease-in, opacity 0.5s ease-in;
        }

        .analytics-item {
            padding: 1rem;
            margin-bottom: 1rem;
            background: rgba(104, 42, 83, 0.05);
            border-left: 4px solid var(--primary);
            border-radius: 0.5rem;
        }

        .analytics-item.high-impact {
            border-left-color: var(--success);
        }

        .analytics-item.medium-impact {
            border-left-color: var(--primary);
        }

        .analytics-item.low-impact {
            border-left-color: rgba(104, 42, 83, 0.4);
        }

        .analytics-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .analytics-item-title {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.95rem;
        }

        .analytics-item-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .analytics-item-badge.high {
            background: rgba(46, 213, 115, 0.2);
            color: var(--success);
        }

        .analytics-item-badge.medium {
            background: rgba(104, 42, 83, 0.2);
            color: var(--primary);
        }

        .analytics-item-badge.low {
            background: rgba(128, 128, 128, 0.2);
            color: #666;
        }

        .analytics-item-desc {
            color: var(--text);
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .analytics-item-reason {
            color: var(--text);
            opacity: 0.7;
            font-size: 0.85rem;
            font-style: italic;
        }

        .keyword-heatmap {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .keyword-item {
            padding: 0.75rem;
            background: rgba(104, 42, 83, 0.05);
            border-radius: 0.5rem;
            text-align: center;
        }

        .keyword-name {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }

        .keyword-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--success);
        }

        .section-score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .section-score-card {
            padding: 1.5rem;
            background: rgba(104, 42, 83, 0.05);
            border-radius: 0.75rem;
            text-align: center;
        }

        .section-score-name {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .section-score-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .section-score-bar {
            width: 100%;
            height: 8px;
            background: rgba(104, 42, 83, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .section-score-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            transition: width 0.5s ease;
        }

        .benchmark-card {
            padding: 2rem;
            background: linear-gradient(135deg, rgba(104, 42, 83, 0.1), rgba(46, 213, 115, 0.1));
            border-radius: 0.75rem;
            margin-top: 1rem;
        }

        .benchmark-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .benchmark-percentile {
            font-size: 3rem;
            font-weight: bold;
            color: var(--primary);
        }

        .benchmark-comparison {
            font-size: 1.25rem;
            color: var(--text);
            margin-top: 0.5rem;
        }

        .benchmark-strengths, .benchmark-improvements {
            margin-top: 1.5rem;
        }

        .benchmark-list {
            list-style: none;
            padding: 0;
        }

        .benchmark-list li {
            padding: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
        }

        .benchmark-list li:before {
            content: '';
            position: absolute;
            left: 0;
            color: var(--success);
            font-weight: bold;
        }

        .benchmark-improvements li:before {
            content: '';
            color: var(--primary);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                max-height: 95vh;
            }

            .modal-header {
                padding: 1.5rem;
            }

            .modal-body {
                padding: 1.5rem;
            }

            .modal-footer {
                padding: 1rem 1.5rem;
                flex-direction: column;
            }

            .modal-footer .btn {
                width: 100%;
            }

            .score-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .score-main {
                flex-direction: column;
                align-items: flex-start;
            }

            .score-potential {
                width: 100%;
                text-align: left;
            }

            .action-header {
                flex-direction: column;
            }

            .action-meta {
                width: 100%;
                justify-content: space-between;
            }

            .breakdown-item-right {
                flex-direction: column;
                align-items: flex-end;
                gap: 0.5rem;
            }
        }

        .suggestions-list li em {
            color: var(--text-muted);
            font-style: normal;
            font-size: 0.95em;
        }

        .optimization-section {
            display: none;
            margin-top: 2rem;
            animation: fadeInUp 0.5s ease-out;
        }

        .optimization-section.show {
            display: block !important;
        }

        /* Statistics Panel */
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
            animation: fadeIn 0.5s ease-out;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(104, 42, 83, 0.1) 0%, rgba(253, 197, 0, 0.05) 100%);
            border: 2px solid rgba(104, 42, 83, 0.3);
            border-radius: 12px;
            padding: 1.25rem;
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(104, 42, 83, 0.15) 0%, rgba(253, 197, 0, 0.1) 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(253, 197, 0, 0.3);
        }

        .stat-icon {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            background: var(--primary);
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .stat-content {
            flex: 1;
        }

        .stat-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .stat-highlight {
            color: var(--accent);
        }

        .stat-change {
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 0.25rem;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--danger);
        }

        .stat-change.neutral {
            color: var(--text-light);
        }

        .stat-detail {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.5rem;
            line-height: 1.4;
        }

        @media (max-width: 1200px) {
            .stats-panel {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .stats-panel {
                grid-template-columns: 1fr;
            }
        }

        .comparison-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 2rem;
            align-items: stretch;
            max-width: 100%;
            overflow: hidden;
        }

        .resume-panel {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            min-height: 500px;
            max-height: 700px;
            box-shadow: 0 8px 20px rgba(104, 42, 83, 0.2);
            overflow: hidden;
            min-width: 0;
        }

        .resume-panel:hover {
            border-color: var(--accent);
            box-shadow: 0 12px 30px rgba(253, 197, 0, 0.4), 0 0 20px rgba(253, 197, 0, 0.3);
            transform: translateY(-2px);
        }

        .resume-panel h4 {
            margin-bottom: 1.5rem;
            color: var(--primary);
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-shrink: 0;
        }

        .resume-panel h4 i {
            color: var(--accent);
        }

        .resume-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-shrink: 0;
        }

        .resume-panel-header h4 {
            margin: 0;
            flex: 1;
        }

        .resume-panel-header .download-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-shrink: 0;
        }

        .resume-content {
            font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;
            font-size: 10pt;
            line-height: 1.3;
            color: #1a1a1a;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 1.5rem;
            background: #ffffff;
            border: 1px solid rgba(104, 42, 83, 0.2);
            border-radius: 8px;
            word-wrap: break-word;
            word-break: break-word;
            min-width: 0;
        }

        /* Custom scrollbar for resume content */
        .resume-content::-webkit-scrollbar {
            width: 8px;
        }

        .resume-content::-webkit-scrollbar-track {
            background: rgba(104, 42, 83, 0.1);
            border-radius: 4px;
        }

        .resume-content::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        .resume-content::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* Resume preview mode styles */
        .resume-content.preview-mode {
            max-height: 400px;
            position: relative;
        }

        .resume-preview-fade {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(to bottom, transparent, rgba(255, 255, 255, 0.95));
            pointer-events: none;
            display: none;
        }

        .resume-content.preview-mode .resume-preview-fade {
            display: block;
        }

        .resume-expand-btn {
            margin-top: 0.75rem;
            margin-bottom: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .resume-expand-btn:hover {
            background: var(--accent);
            transform: translateY(-1px);
        }

        .resume-expand-btn i {
            transition: transform 0.3s ease;
        }

        .resume-expand-btn.expanded i {
            transform: rotate(180deg);
        }

        /* Original resume styling - matches textarea appearance */
        #original-resume-panel .resume-content,
        #original-resume {
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.8;
            color: #1a1a1a;
            background: rgba(255, 255, 255, 0.06);
            border: 2px solid rgba(104, 42, 83, 0.3);
            border-radius: 16px;
            padding: 1.5rem 1.75rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.15),
                0 2px 8px rgba(104, 42, 83, 0.1);
        }

        #original-resume-panel .resume-content *,
        #original-resume * {
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.8;
            color: #1a1a1a;
            background: transparent;
            border: none;
            padding: 0;
            margin: 0;
        }

        /* Remove any template-specific styling from original resume */
        #original-resume-panel .resume-header-name,
        #original-resume-panel .resume-header-contact,
        #original-resume-panel .resume-header-title,
        #original-resume-panel .resume-main-section,
        #original-resume-panel .resume-section-header,
        #original-resume-panel .resume-normal {
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.8;
            color: var(--text);
            background: transparent;
            border: none;
            padding: 0;
            margin: 0;
            font-weight: normal;
        }
            flex: 1;
            min-height: 0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .resume-header-name {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif !important;
            font-size: 20pt;
            font-weight: 700;
            color: #000000;
            margin-top: 0;
            margin-bottom: 11px;
            text-align: center;
            line-height: 26pt;
            letter-spacing: 0 !important;
        }

        .resume-header-title {
            font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;
            font-size: 11pt;
            font-weight: 700;
            color: #000000;
            margin-top: 3px;
            margin-bottom: 13px;
            text-align: center;
            line-height: 15pt;
        }

        .resume-header-contact {
            font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;
            font-size: 10pt;
            font-weight: 400;
            color: #FFFFFF;
            /* White text on colored background */
            background-color: #000000;
            /* Default black, will be overridden by template */
            margin-top: 7px;
            margin-bottom: 27px;
            padding: 0.5rem 1rem;
            text-align: center;
            line-height: 16pt;
            border-radius: 0;
        }

        .resume-main-section {
            font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;
            font-size: 12pt;
            font-weight: 700;
            color: #000000;
            /* Default black */
            margin-top: 21px;
            margin-bottom: 11px;
            padding-bottom: 0.2rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.2);
            text-align: left;
        }

        .resume-main-section:first-child {
            margin-top: 0;
        }

        /* Template-specific styles */
        /* Professional Modern - Blue accents with underlines */
        .template-professional_modern .resume-main-section {
            color: #2563eb;
            border-bottom: 2px solid #2563eb;
        }

        .template-professional_modern .resume-header-name {
            border-bottom: 2px solid #2563eb;
            padding-bottom: 0.3rem;
            margin-bottom: 0.5rem;
        }

        .template-professional_modern .resume-header-contact {
            background-color: #2563eb;
            /* Blue background */
            color: #FFFFFF;
            /* White text */
        }

        /* Tech Minimalist - Minimal, no special styling */
        .template-tech_minimalist .resume-main-section {
            color: #000000;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .template-tech_minimalist .resume-header-name {
            border-bottom: none;
        }

        .template-tech_minimalist .resume-header-contact {
            background-color: #000000;
            /* Black background */
            color: #FFFFFF;
            /* White text */
        }

        /* Data Professional - Teal accents with underlines */
        .template-data_professional .resume-main-section {
            color: #14b8a6;
            border-bottom: 2px solid #14b8a6;
        }

        .template-data_professional .resume-header-name {
            border-bottom: 3px solid #14b8a6;
            padding-bottom: 0.3rem;
            margin-bottom: 0.5rem;
        }

        .template-data_professional .resume-header-contact {
            background-color: #14b8a6;
            /* Teal background */
            color: #FFFFFF;
            /* White text */
        }

        .template-data_professional .resume-category {
            color: #14b8a6;
        }

        .resume-category {
            font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;
            font-size: 11pt;
            font-weight: 600;
            color: #682A53;
            margin-top: 8px;
            margin-bottom: 4px;
            margin-left: 0;
            text-align: left;
        }

        .resume-experience-entry {
            font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;
            color: #1a1a1a;
            margin-top: 8px;
            margin-bottom: 4px;
            margin-left: 0;
            line-height: 1.3;
            text-align: left;
        }

        .resume-project-entry {
            font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;
            font-size: 11pt;
            font-weight: 700;
            color: #000000;
            /* Black color instead of maroon */
            margin-top: 8px;
            margin-bottom: 4px;
            margin-left: 0;
            line-height: 1.3;
            text-align: left;
        }

        .resume-bullet {
            font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;
            font-size: 10.5pt;
            font-weight: 400;
            color: #2d2d2d;
            margin-left: 0;
            margin-top: 1.5px;
            margin-bottom: 4px;
            padding-left: 18px;
            line-height: 15pt;
            text-align: left;
            text-indent: -18px;
        }

        .resume-bullet::before {
            content: " ";
            margin-right: 8px;
        }

        .resume-normal {
            font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;
            font-size: 10pt;
            font-weight: 400;
            color: #1a1a1a;
            margin-top: 3px;
            margin-bottom: 7px;
            line-height: 15pt;
            text-align: left;
        }

        /* Styles for experience entry parts */
        .resume-company {
            font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;
            font-size: 11pt;
            font-weight: 700;
        }

        .resume-job-title {
            font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;
            font-size: 11pt;
            font-weight: 400;
        }

        .resume-date {
            font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;
            font-size: 10pt;
            font-weight: 400;
        }

        /* Enhanced change tracking - granular diff */
        /* Additions - Green highlight */
        .resume-added {
            background-color: rgba(16, 185, 129, 0.2) !important;
            border-left: 3px solid #10b981;
            padding-left: 0.5rem;
            margin-left: -0.5rem;
            transition: all 0.2s ease;
        }

        .resume-added:hover {
            background-color: rgba(16, 185, 129, 0.3) !important;
        }

        .resume-added::before {
            content: "+ ";
            color: #10b981;
            font-weight: 700;
            margin-right: 0.25rem;
        }

        /* Modifications - Yellow highlight */
        .resume-modified {
            background-color: rgba(253, 197, 0, 0.25) !important;
            border-left: 3px solid #FDC500;
            padding-left: 0.5rem;
            margin-left: -0.5rem;
            transition: all 0.2s ease;
        }

        .resume-modified:hover {
            background-color: rgba(253, 197, 0, 0.35) !important;
        }

        .resume-modified::before {
            content: "~ ";
            color: #FDC500;
            font-weight: 700;
            margin-right: 0.25rem;
        }

        /* Legacy support for .resume-changed (treated as modified) */
        .resume-changed {
            background-color: rgba(253, 197, 0, 0.25) !important;
            border-left: 3px solid #FDC500;
            padding-left: 0.5rem;
            margin-left: -0.5rem;
            transition: background-color 0.2s ease;
        }

        .resume-changed:hover {
            background-color: rgba(253, 197, 0, 0.35) !important;
        }

        .resume-content::-webkit-scrollbar {
            width: 8px;
        }

        .resume-content::-webkit-scrollbar-track {
            background: rgba(104, 42, 83, 0.1);
            border-radius: 4px;
        }

        .resume-content::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        .resume-content::-webkit-scrollbar-thumb:hover {
            background: var(--primary-light);
        }

        @media (max-width: 600px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .comparison-view {
                grid-template-columns: 1fr;
                align-items: start;
            }

            .resume-panel-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .download-controls {
                flex-direction: column !important;
                gap: 0.75rem !important;
            }

            .download-controls select,
            .download-controls button {
                width: 100% !important;
                max-width: 100% !important;
                min-width: 100% !important;
            }

            .container {
                padding: 1rem;
            }

            .logo-icon {
                width: 70px;
                height: 70px;
            }

            .logo-text .career {
                font-size: 2.2rem;
            }

            .logo-text .vest {
                font-size: 0.95rem;
            }

            .header {
                padding: 2rem 0;
            }

            .card {
                padding: 1.5rem;
            }
        }

        .filename-display {
            margin-top: 0.75rem;
            padding: 0.75rem 1rem;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 8px;
            color: var(--primary-light);
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Template Carousel Styles */
        .template-option {
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 12px;
            padding: 0.5rem;
            border: 2px solid transparent;
            background: rgba(255, 255, 255, 0.03);
        }

        .template-option:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .template-option.active {
            border-color: var(--accent);
            background: rgba(253, 197, 0, 0.1);
            box-shadow: 0 0 15px rgba(253, 197, 0, 0.2);
        }

        .template-preview {
            height: 80px;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            padding: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .template-name {
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
            color: #1a1a1a;
        }

        .template-option.active .template-name {
            color: var(--accent);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <div class="careervest-logo">
                    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="CareerVest Logo" style="height: 90px; width: auto; filter: drop-shadow(0 0 20px rgba(253, 197, 0, 0.6));">
                </div>
            </div>
            <h1>Resume Match</h1>
            <p>AI-Powered Resume Optimization for Your Dream Job</p>
        </div>

        <div id="message" class="message"></div>

        <div class="main-content">
            <div class="card">
                <h2><i class="fas fa-file-alt"></i> Your Resume</h2>
                <div class="form-group">
                    <label for="resume-upload">Upload Resume (PDF, DOCX, TXT)</label>
                    <div class="upload-area">
                        <input type="file" id="resume-upload" accept=".pdf,.docx,.doc,.txt" style="display: none;"
                            onchange="handleResumeUpload(event)">
                        <button type="button" class="btn btn-upload"
                            onclick="document.getElementById('resume-upload').click()">
                            <i class="fas fa-cloud-upload-alt"></i> Choose File
                        </button>
                        <div id="resume-filename" class="filename-display" style="display: none;"></div>
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <label style="font-size: 0.9rem; color: var(--text-muted); font-weight: 500;">Or paste your
                            resume content:</label>
                        <textarea id="resume-text"
                            placeholder="John Doe&#10;Software Engineer&#10;&#10;EXPERIENCE&#10;Senior Software Engineer at Tech Corp (2020-2024)&#10;- Developed web applications using Python and JavaScript&#10;- Led team of 5 developers&#10;&#10;SKILLS&#10;Python, JavaScript, React, AWS, Docker"></textarea>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-file-alt"></i> Job Description</h2>
                <!-- Template selector moved to bottom -->
                <div class="form-group">
                    <label for="ai-provider">AI Model for Analysis</label>
                    <select id="ai-provider"
                        style="padding: 0.875rem 1.25rem; background: rgba(255, 255, 255, 0.1); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.95rem; cursor: pointer; outline: none; transition: all 0.3s; width: 100%; margin-bottom: 1rem;"
                        onchange="updateProviderStatus()">
                        <option value="groq" style="background: var(--bg-card); color: var(--text);">Groq (Llama 3.3) -
                            Fast & Cost-effective</option>
                    </select>
                    <div id="provider-status"
                        style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem; padding: 0.5rem; background: rgba(255, 255, 255, 0.05); border-radius: 6px;">
                    </div>
                </div>
                <div class="form-group">
                    <label for="job-description">Paste Job Description</label>
                    <textarea id="job-description"
                        placeholder="Senior Software Engineer&#10;&#10;We are looking for a Senior Software Engineer with:&#10;- 5+ years experience in Python and JavaScript&#10;- Experience with React, Node.js, and AWS&#10;- Strong problem-solving skills&#10;- Leadership experience"></textarea>
                </div>
            </div>
        </div>

        <div class="btn-center">
            <button id="analyze-btn" class="btn btn-primary" onclick="analyzeResume()">
                <i class="fas fa-search"></i> Analyze Resume
            </button>
        </div>

        <!-- Premium Loading Overlay with Multi-Stage Progress -->
        <div id="loading" class="loading">
            <div class="loading-overlay">
                <div class="loading-content">
                    <!-- Animated CareerVest Logo -->
                    <div class="loading-logo">
                        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="CareerVest" class="pulse-animation">
                    </div>

                    <!-- Loading Animation -->
                    <div class="loading-dots">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>

                    <!-- Dynamic Message -->
                    <div class="loading-message">
                        <h3 id="loading-title">Analyzing Your Resume</h3>
                        <p id="loading-subtitle">We appreciate your patience. We're working on something amazing!</p>
                    </div>

                    <!-- Multi-Stage Progress Indicator -->
                    <div class="loading-progress">
                        <div class="progress-stages">
                            <div class="progress-stage active" data-stage="1">
                                <div class="stage-icon"><i class="fas fa-search"></i></div>
                                <div class="stage-label">Analyzing</div>
                                <div class="stage-status">In Progress</div>
                            </div>
                            <div class="progress-connector"></div>
                            <div class="progress-stage" data-stage="2">
                                <div class="stage-icon"><i class="fas fa-cogs"></i></div>
                                <div class="stage-label">Optimizing</div>
                                <div class="stage-status">Waiting</div>
                            </div>
                            <div class="progress-connector"></div>
                            <div class="progress-stage" data-stage="3">
                                <div class="stage-icon"><i class="fas fa-key"></i></div>
                                <div class="stage-label">Keywords</div>
                                <div class="stage-status">Waiting</div>
                            </div>
                            <div class="progress-connector"></div>
                            <div class="progress-stage" data-stage="4">
                                <div class="stage-icon"><i class="fas fa-check-circle"></i></div>
                                <div class="stage-label">Finalizing</div>
                                <div class="stage-status">Waiting</div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <div class="progress-percentage" id="progress-percentage">0%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Preview Modal -->
        <div id="export-preview-modal" class="modal" style="display: none;">
            <div class="modal-overlay" onclick="closeExportPreview()"></div>
            <div class="modal-content export-preview-content">
                <div class="modal-header">
                    <h2><i class="fas fa-eye"></i> Preview Before Download</h2>
                    <button class="modal-close" onclick="closeExportPreview()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="preview-info">
                        <div class="info-badge">
                            <i class="fas fa-info-circle"></i>
                            <span>This is how your resume will look in <span id="preview-format-name">PDF</span> format</span>
                        </div>
                    </div>
                    <div class="preview-container">
                        <div id="export-preview-content" class="export-preview-display"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeExportPreview()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="btn btn-primary" onclick="proceedWithDownload()">
                        <i class="fas fa-download"></i> Download Resume
                    </button>
                </div>
            </div>
        </div>

        <div id="results" style="display: none;" class="results-section">
            <!-- Ultra Clean Score Display -->
            <div class="dashboard-score-card" style="text-align: center; padding: 3rem 2rem;">
                <div class="score-main" style="display: flex; flex-direction: column; align-items: center; gap: 1.5rem;">
                    <div id="score-circle" class="score-circle" style="margin: 0;">
                        <span id="score-value">0%</span>
                    </div>
                    <div class="score-info">
                        <h2 id="score-message" style="margin-bottom: 0.5rem;">Analyzing...</h2>
                        <p id="score-description" style="font-size: 1.1rem;"></p>
                    </div>

                    <!-- Primary CTA Button -->
                    <div id="optimization-section-inline" class="optimization-section" style="margin-top: 1rem; width: 100%; max-width: 400px;">
                        <button id="optimize-btn-main" class="btn btn-primary" onclick="optimizeResume()"
                                style="width: 100%; padding: 1.25rem 2rem; font-size: 1.1rem; font-weight: 700;">
                            <i class="fas fa-magic"></i> Optimize My Resume
                        </button>
                    </div>

                    <!-- Show Details Toggle -->
                    <button onclick="toggleResultsDetails()"
                            style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.95rem; margin-top: 1rem; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s;">
                        <span id="details-toggle-text"> Show Detailed Analysis</span>
                    </button>
                </div>
            </div>

            <!-- Detailed Analysis Section (Hidden by Default) -->
            <div id="detailed-analysis" style="display: none; margin-top: 2rem;">
                <!-- Score Header with Potential -->
                <div class="dashboard-score-card">
                    <div class="score-header">
                        <div class="score-potential">
                            <div class="potential-badge">
                                <span class="potential-label">Potential</span>
                                <span id="potential-score" class="potential-value">0/100</span>
                            </div>
                        </div>
                    </div>

                    <!-- Score Breakdown -->
                    <div class="score-breakdown">
                        <h3><i class="fas fa-chart-bar"></i> Score Breakdown</h3>
                        <div id="score-breakdown-items" class="breakdown-items">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <div class="breakdown-footer">
                            <p id="breakdown-message"><i class="fas fa-lightbulb"></i> Complete critical actions to reach your potential score</p>
                        </div>
                    </div>
                </div>

            <!-- Middle Section: Priority Actions -->
            <div class="actions-dashboard">
                <h2 class="dashboard-title"><i class="fas fa-rocket"></i> Recommended Actions</h2>

                <!-- Critical Actions -->
                <div id="critical-actions" class="priority-section" style="display: none;">
                    <div class="priority-header critical-header">
                        <span class="priority-icon"></span>
                        <h3>CRITICAL (Fix these first)</h3>
                    </div>
                    <div id="critical-actions-list" class="actions-list">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- High Impact Actions -->
                <div id="high-impact-actions" class="priority-section" style="display: none;">
                    <div class="priority-header high-impact-header">
                        <span class="priority-icon"></span>
                        <h3>HIGH IMPACT (Quick wins)</h3>
                    </div>
                    <div id="high-impact-actions-list" class="actions-list">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Polish Actions -->
                <div id="polish-actions" class="priority-section" style="display: none;">
                    <div class="priority-header polish-header collapsible-header" onclick="togglePolishSection()">
                        <span>
                            <span class="priority-icon"></span>
                            <h3 style="display: inline;">POLISH (Nice to have)</h3>
                        </span>
                        <i class="fas fa-chevron-down toggle-icon" id="polish-toggle-icon"></i>
                    </div>
                    <div id="polish-actions-list" class="actions-list collapsible-content">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Collapsible Strengths Section -->
            <div class="strengths-collapsible">
                <button class="collapsible-header" onclick="toggleStrengths()">
                    <span><i class="fas fa-check-circle" style="color: var(--success);"></i> What's Already Great</span>
                    <i id="strengths-toggle-icon" class="fas fa-chevron-down"></i>
                </button>
                <div id="strengths-content" class="collapsible-content" style="display: none;">
                    <ul id="strengths-list" class="strengths-list"></ul>
                    <p class="strengths-footer"><i class="fas fa-info-circle"></i> Keep these elements in your optimized version!</p>
                </div>
            </div>

            <!-- ATS Compliance Card -->
            <div id="ats-analysis-card" style="display: none;" class="analysis-card">
                <h3><i class="fas fa-check-square" style="color: #FDC500;"></i> ATS Compliance Score</h3>
                <div id="ats-analysis-content"></div>
            </div>

            </div>
            <!-- End of Detailed Analysis Section -->
        </div>

        <div id="optimization-results" style="display: none;" class="results-section">
            <!-- Ultra Clean Score Improvement Display -->
            <div class="dashboard-score-card" style="text-align: center; padding: 3rem 2rem;">
                <h2 style="margin-bottom: 2rem; font-size: 2rem;">
                    <i class="fas fa-check-circle" style="color: var(--success);"></i> Resume Optimized!
                </h2>

                <!-- Score Improvement Summary -->
                <div id="score-comparison-summary" style="margin-bottom: 2rem;">
                    <!-- Will be populated by JavaScript -->
                </div>

            </div>

            <!-- Before / After Comparison (Always Visible) -->
            <div class="analysis-card" id="before-after-comparison" style="margin-top: 2rem;">
                <h3><i class="fas fa-code-branch" style="color: var(--primary);"></i> Before / After Comparison</h3>

                <div class="comparison-view">
                    <div class="resume-panel" id="original-resume-panel">
                        <h4><i class="fas fa-file-alt"></i> Original Resume</h4>
                        <div id="original-resume" class="resume-content"></div>
                    </div>
                    <div class="resume-panel" id="optimized-resume-panel">
                        <div class="resume-panel-header">
                            <h4><i class="fas fa-star"></i> Optimized Resume</h4>
                        </div>
                        <button class="resume-expand-btn" id="resume-expand-btn" onclick="toggleResumePreview()" style="display: none;">
                            <i class="fas fa-chevron-down"></i>
                            <span id="resume-expand-text">Show Full Resume</span>
                        </button>
                        <div id="optimized-resume" class="resume-content preview-mode">
                            <div class="resume-preview-fade"></div>
                        </div>

                        <!-- Template Selection & Download Section -->
                        <div id="download-section"
                            style="display: none; margin-top: 1.5rem; border-top: 1px solid var(--border); padding-top: 1.5rem;">

                            <!-- Download Controls -->
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                <!-- Format Selection -->
                                <div>
                                    <label style="display: block; font-size: 0.85rem; font-weight: 600; color: var(--primary); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                        Select Format
                                    </label>
                                    <select id="download-format"
                                        style="width: 100%; padding: 0.875rem 1.25rem; background: #ffffff; border: 2px solid rgba(104, 42, 83, 0.3); border-radius: 8px; color: #1a1a1a; font-size: 1rem; font-weight: 500; cursor: pointer; outline: none; transition: all 0.3s;">
                                        <option value="pdf">PDF Document (.pdf)</option>
                                        <option value="docx">Word Document (.docx)</option>
                                        <option value="txt">Text File (.txt)</option>
                                    </select>
                                </div>

                                <!-- Download Button -->
                                <button class="btn btn-download" onclick="downloadOptimizedResume()" id="download-btn"
                                    style="width: 100%; padding: 1rem 1.5rem; font-size: 1rem; font-weight: 600;">
                                    <i class="fas fa-download"></i> Download Resume
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Show Detailed Analytics Toggle -->
            <div style="text-align: center; margin: 2rem 0;">
                <button onclick="toggleOptimizationDetails()"
                        style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.95rem; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.3s;">
                    <span id="optimization-details-toggle-text"> Show Detailed Analytics</span>
                </button>
            </div>

            <!-- Detailed Analytics Section (Hidden by Default) -->
            <div id="detailed-optimization-analytics" style="display: none;">

                <!-- Score Comparison Card -->
                <div id="score-comparison-card" style="display: none; margin-bottom: 2rem;" class="analysis-card">
                    <h3><i class="fas fa-chart-line" style="color: var(--primary);"></i> Score Improvement</h3>
                    <div id="score-comparison-content"></div>
                </div>

            <!-- Section Breakdown Card -->
            <div id="section-breakdown-card" style="display: none; margin-bottom: 2rem;" class="analysis-card">
                <h3><i class="fas fa-list-check" style="color: var(--primary);"></i> Section Improvements</h3>
                <div id="section-breakdown-content"></div>
            </div>

            <!-- Additional Suggestions Card (if score < 60%) -->
            <div id="additional-suggestions-card"
                style="display: none; margin-bottom: 2rem; border-left: 4px solid var(--warning);"
                class="analysis-card">
                <h3><i class="fas fa-lightbulb" style="color: var(--warning);"></i> Additional Suggestions</h3>
                <div id="additional-suggestions-content"></div>
            </div>

            <!-- Analytics & Insights Card -->
            <div id="analytics-insights-card" style="display: none; margin-bottom: 2rem;" class="analysis-card">
                <h3 class="collapsible-header" onclick="toggleAnalyticsSection()">
                    <span><i class="fas fa-chart-bar" style="color: var(--primary);"></i> Analytics & Insights</span>
                    <i class="fas fa-chevron-down toggle-icon" id="analytics-toggle-icon"></i>
                </h3>
                <div id="analytics-insights-content" class="collapsible-content">
                    <!-- Tab navigation -->
                    <div class="analytics-tabs">
                        <button class="analytics-tab active" onclick="switchAnalyticsTab('changes')">
                            <i class="fas fa-exchange-alt"></i> Changes Made
                        </button>
                        <button class="analytics-tab" onclick="switchAnalyticsTab('keywords')">
                            <i class="fas fa-key"></i> Keyword Analysis
                        </button>
                        <button class="analytics-tab" onclick="switchAnalyticsTab('scores')">
                            <i class="fas fa-star"></i> Section Scores
                        </button>
                        <button class="analytics-tab" onclick="switchAnalyticsTab('suggestions')">
                            <i class="fas fa-lightbulb"></i> Improvements
                        </button>
                        <button class="analytics-tab" onclick="switchAnalyticsTab('benchmark')">
                            <i class="fas fa-trophy"></i> Benchmark
                        </button>
                    </div>

                    <!-- Tab content -->
                    <div id="analytics-tab-changes" class="analytics-tab-content active"></div>
                    <div id="analytics-tab-keywords" class="analytics-tab-content"></div>
                    <div id="analytics-tab-scores" class="analytics-tab-content"></div>
                    <div id="analytics-tab-suggestions" class="analytics-tab-content"></div>
                    <div id="analytics-tab-benchmark" class="analytics-tab-content"></div>
                </div>
            </div>

            <!-- Statistics Panel (Kept in detailed analytics) -->
            <div class="analysis-card">
                <h3><i class="fas fa-chart-bar" style="color: var(--primary);"></i> Statistics</h3>

                <!-- Statistics Panel -->
                <div class="stats-panel" id="stats-panel" style="display: none;">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-file-word"></i></div>
                        <div class="stat-content">
                            <div class="stat-label">Word Count</div>
                            <div class="stat-value">
                                <span id="stat-word-before">0</span>  <span id="stat-word-after" class="stat-highlight">0</span>
                            </div>
                            <div class="stat-change" id="stat-word-change"></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-key"></i></div>
                        <div class="stat-content">
                            <div class="stat-label">Keywords Added</div>
                            <div class="stat-value">
                                <span id="stat-keywords-added" class="stat-highlight">0</span> new keywords
                            </div>
                            <div class="stat-detail" id="stat-keywords-list"></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-edit"></i></div>
                        <div class="stat-content">
                            <div class="stat-label">Sections Modified</div>
                            <div class="stat-value">
                                <span id="stat-sections-count" class="stat-highlight">0</span> sections
                            </div>
                            <div class="stat-detail" id="stat-sections-list"></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                        <div class="stat-content">
                            <div class="stat-label">Improvement</div>
                            <div class="stat-value">
                                <span id="stat-improvement" class="stat-highlight">+0%</span>
                            </div>
                            <div class="stat-detail" id="stat-improvement-detail"></div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            <!-- End of Detailed Optimization Analytics Section -->
        </div>
    </div>

    <script>
        // Global variables
        let currentResumeText = '';
        let currentJobDescription = '';
        let currentSuggestions = [];
        let currentOptimizedResumeText = '';
        let currentOriginalResumeText = '';  // Store original resume text for comparison
        let currentOriginalScore = null;  // Store original match score
        let currentTemplate = 'professional_modern';  // Default template

        // Store suggestions data
        let suggestionMap = {};
        let acceptedSuggestionIds = new Set();

        // Loading messages for rotation
        const loadingMessages = [
            {
                title: "Analyzing Your Resume",
                subtitle: "We appreciate your patience. We're working on something amazing!"
            },
            {
                title: "Crafting Your Success",
                subtitle: "Every great career starts with a great resume. We're making yours shine!"
            },
            {
                title: "Optimizing for Impact",
                subtitle: "Your dream job is within reach. Let's make your resume stand out!"
            },
            {
                title: "Enhancing Your Profile",
                subtitle: "Great things take time. We're creating something special for you!"
            },
            {
                title: "Building Your Future",
                subtitle: "Your next opportunity awaits. We're helping you get there!"
            }
        ];

        let messageRotationInterval = null;

        function startLoadingMessages() {
            let currentMessageIndex = 0;

            // Clear any existing interval
            if (messageRotationInterval) {
                clearInterval(messageRotationInterval);
            }

            // Rotate messages every 3 seconds
            messageRotationInterval = setInterval(() => {
                currentMessageIndex = (currentMessageIndex + 1) % loadingMessages.length;
                const message = loadingMessages[currentMessageIndex];

                const titleEl = document.getElementById('loading-title');
                const subtitleEl = document.getElementById('loading-subtitle');

                if (titleEl && subtitleEl) {
                    // Fade out
                    titleEl.style.opacity = '0';
                    subtitleEl.style.opacity = '0';

                    // Change text after fade
                    setTimeout(() => {
                        titleEl.textContent = message.title;
                        subtitleEl.textContent = message.subtitle;

                        // Fade in
                        titleEl.style.opacity = '1';
                        subtitleEl.style.opacity = '1';
                    }, 300);
                }
            }, 3000);
        }

        function stopLoadingMessages() {
            if (messageRotationInterval) {
                clearInterval(messageRotationInterval);
                messageRotationInterval = null;
            }
        }

        // Progress Stage Management
        let progressInterval = null;

        function updateProgressStage(stage) {
            // stage: 1 = Analyzing, 2 = Optimizing, 3 = Keywords, 4 = Finalizing
            const stages = document.querySelectorAll('.progress-stage');
            const connectors = document.querySelectorAll('.progress-connector');
            const progressFill = document.getElementById('progress-fill');
            const progressPercentage = document.getElementById('progress-percentage');

            // Update stages
            stages.forEach((stageEl, index) => {
                const stageNum = parseInt(stageEl.dataset.stage);
                const statusEl = stageEl.querySelector('.stage-status');

                if (stageNum < stage) {
                    stageEl.classList.remove('active');
                    stageEl.classList.add('completed');
                    if (statusEl) statusEl.textContent = 'Done';
                } else if (stageNum === stage) {
                    stageEl.classList.remove('completed');
                    stageEl.classList.add('active');
                    if (statusEl) statusEl.textContent = 'In Progress';
                } else {
                    stageEl.classList.remove('active', 'completed');
                    if (statusEl) statusEl.textContent = 'Waiting';
                }
            });

            // Update connectors
            connectors.forEach((connector, index) => {
                if (index < stage - 1) {
                    connector.classList.add('completed');
                } else {
                    connector.classList.remove('completed');
                }
            });

            // Update progress bar
            const percentage = (stage / 4) * 100;
            if (progressFill) {
                progressFill.style.width = percentage + '%';
            }
            if (progressPercentage) {
                progressPercentage.textContent = Math.round(percentage) + '%';
            }
        }

        function startProgressAnimation() {
            // Simulated progress through stages
            let currentStage = 1;
            updateProgressStage(currentStage);

            progressInterval = setInterval(() => {
                currentStage++;
                if (currentStage <= 4) {
                    updateProgressStage(currentStage);
                } else {
                    clearInterval(progressInterval);
                }
            }, 2500); // Progress through stages every 2.5 seconds
        }

        function stopProgressAnimation() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            // Set to completion
            updateProgressStage(4);
        }

        function resetProgress() {
            updateProgressStage(1);
            const progressFill = document.getElementById('progress-fill');
            const progressPercentage = document.getElementById('progress-percentage');
            if (progressFill) progressFill.style.width = '0%';
            if (progressPercentage) progressPercentage.textContent = '0%';
        }

        // Template information
        const templateInfo = {
            professional_modern: {
                name: "Professional Modern",
                description: "Best for corporate positions, business roles, traditional companies",
                accent: "#2563eb"
            },
            tech_minimalist: {
                name: "Tech Minimalist",
                description: "Best for tech companies, startups, ATS-optimized",
                accent: "#000000"
            },
            data_professional: {
                name: "Data Professional",
                description: "Best for data analyst/scientist roles, research positions",
                accent: "#14b8a6"
            }
        };

        function selectTemplate(templateName) {
            // Update current template
            currentTemplate = templateName;
            
            // Update active state in template carousel
            document.querySelectorAll('.template-option').forEach(option => {
                option.classList.remove('active');
            });
            const selectedOption = document.getElementById(`tmpl-${templateName}`);
            if (selectedOption) {
                selectedOption.classList.add('active');
            }
            
            // Update template info if element exists
            const templateInfoDiv = document.getElementById('template-info');
            if (templateInfoDiv && templateInfo[currentTemplate]) {
                templateInfoDiv.textContent = templateInfo[currentTemplate].description;
            }
            
            // Apply template styling (only to optimized resume)
            applyTemplateStyling();
        }

        function updateTemplateInfo() {
            const templateSelect = document.getElementById('resume-template');
            const templateInfoDiv = document.getElementById('template-info');
            if (templateSelect && templateInfoDiv) {
                currentTemplate = templateSelect.value;
                const info = templateInfo[currentTemplate];
                if (info) {
                    templateInfoDiv.textContent = info.description;
                }
                // Apply template class to resume containers
                applyTemplateStyling();
            }
        }

        function applyTemplateStyling() {
            // Remove all template classes and add current template class
            const templateClass = `template-${currentTemplate}`;
            const allTemplateClasses = ['template-professional_modern', 'template-tech_minimalist', 'template-data_professional'];

            // Apply template ONLY to optimized resume (NOT original)
            const optimizedResume = document.getElementById('optimized-resume');
            const optimizedPanel = document.getElementById('optimized-resume-panel');

            if (optimizedResume) {
                allTemplateClasses.forEach(cls => optimizedResume.classList.remove(cls));
                optimizedResume.classList.add(templateClass);
            }

            if (optimizedPanel) {
                allTemplateClasses.forEach(cls => optimizedPanel.classList.remove(cls));
                optimizedPanel.classList.add(templateClass);
            }

            // Remove template classes from original resume (keep it unchanged)
            const originalResume = document.getElementById('original-resume');
            const originalPanel = document.getElementById('original-resume-panel');

            if (originalResume) {
                allTemplateClasses.forEach(cls => originalResume.classList.remove(cls));
            }

            if (originalPanel) {
                allTemplateClasses.forEach(cls => originalPanel.classList.remove(cls));
            }

            // Do NOT apply template to comparison-view container
            // Templates should only be applied to optimized resume elements, not the container
            const comparisonView = document.querySelector('.comparison-view');
            if (comparisonView) {
                allTemplateClasses.forEach(cls => comparisonView.classList.remove(cls));
            }
        }

        // Function to calculate and display statistics
        function displayStatistics(originalText, optimizedText, scoreData) {
            const statsPanel = document.getElementById('stats-panel');
            if (!statsPanel) return;

            // Calculate word counts
            const originalWords = originalText.trim().split(/\s+/).length;
            const optimizedWords = optimizedText.trim().split(/\s+/).length;
            const wordChange = optimizedWords - originalWords;
            const wordChangePercent = originalWords > 0 ? ((wordChange / originalWords) * 100).toFixed(1) : 0;

            // Extract keywords (simple approach: words longer than 4 chars, excluding common words)
            const commonWords = new Set(['this', 'that', 'with', 'from', 'have', 'been', 'were', 'their', 'there', 'where', 'when', 'what', 'which', 'while', 'who', 'whom', 'whose', 'will', 'would', 'could', 'should', 'the', 'and', 'for', 'are', 'but', 'not', 'you', 'all', 'can', 'her', 'was', 'one', 'our', 'out', 'day', 'get', 'has', 'him', 'his', 'how', 'its', 'may', 'new', 'now', 'old', 'see', 'two', 'way', 'who', 'boy', 'did', 'let', 'put', 'say', 'she', 'too', 'use']);

            const extractKeywords = (text) => {
                return new Set(
                    text.toLowerCase()
                        .split(/\s+/)
                        .filter(word => word.length > 4 && !commonWords.has(word))
                        .map(word => word.replace(/[^a-z0-9]/g, ''))
                        .filter(word => word.length > 4)
                );
            };

            const originalKeywords = extractKeywords(originalText);
            const optimizedKeywords = extractKeywords(optimizedText);
            const newKeywords = [...optimizedKeywords].filter(k => !originalKeywords.has(k));

            // Count sections modified
            const originalLines = originalText.split('\n').map(l => l.trim()).filter(l => l);
            const optimizedLines = optimizedText.split('\n').map(l => l.trim()).filter(l => l);
            const originalLineSet = new Set(originalLines);
            const modifiedLines = optimizedLines.filter(l => !originalLineSet.has(l)).length;
            const totalLines = optimizedLines.length;
            const modificationPercent = totalLines > 0 ? ((modifiedLines / totalLines) * 100).toFixed(0) : 0;

            // Detect modified sections
            const sectionHeaders = ['SUMMARY', 'EXPERIENCE', 'EDUCATION', 'SKILLS', 'PROJECTS', 'CERTIFICATIONS'];
            const modifiedSections = [];
            sectionHeaders.forEach(header => {
                const inOriginal = originalText.toUpperCase().includes(header);
                const inOptimized = optimizedText.toUpperCase().includes(header);
                if (inOriginal && inOptimized) {
                    // Check if content changed
                    const origIndex = originalText.toUpperCase().indexOf(header);
                    const optIndex = optimizedText.toUpperCase().indexOf(header);
                    if (origIndex >= 0 && optIndex >= 0) {
                        const origSection = originalText.substring(origIndex, origIndex + 200);
                        const optSection = optimizedText.substring(optIndex, optIndex + 200);
                        if (origSection !== optSection) {
                            modifiedSections.push(header);
                        }
                    }
                } else if (!inOriginal && inOptimized) {
                    modifiedSections.push(header + ' (Added)');
                }
            });

            // Calculate improvement (from score data)
            let improvement = 0;
            let improvementDetail = '';
            if (scoreData && scoreData.new_score && scoreData.original_score) {
                improvement = scoreData.new_score - scoreData.original_score;
                improvementDetail = `Score increased from ${scoreData.original_score}% to ${scoreData.new_score}%`;
            } else {
                // Estimate improvement based on changes
                improvement = Math.min(Math.round(modificationPercent / 3), 25);
                improvementDetail = `${modificationPercent}% of content modified`;
            }

            // Update word count
            document.getElementById('stat-word-before').textContent = originalWords;
            document.getElementById('stat-word-after').textContent = optimizedWords;
            const wordChangeEl = document.getElementById('stat-word-change');
            if (wordChange > 0) {
                wordChangeEl.textContent = `+${wordChange} words (+${wordChangePercent}%)`;
                wordChangeEl.className = 'stat-change positive';
            } else if (wordChange < 0) {
                wordChangeEl.textContent = `${wordChange} words (${wordChangePercent}%)`;
                wordChangeEl.className = 'stat-change negative';
            } else {
                wordChangeEl.textContent = 'No change';
                wordChangeEl.className = 'stat-change neutral';
            }

            // Update keywords
            document.getElementById('stat-keywords-added').textContent = newKeywords.length;
            const keywordsList = document.getElementById('stat-keywords-list');
            if (newKeywords.length > 0) {
                const topKeywords = newKeywords.slice(0, 5);
                keywordsList.textContent = topKeywords.join(', ') + (newKeywords.length > 5 ? '...' : '');
            } else {
                keywordsList.textContent = 'No new keywords detected';
            }

            // Update sections
            document.getElementById('stat-sections-count').textContent = modifiedSections.length;
            const sectionsList = document.getElementById('stat-sections-list');
            if (modifiedSections.length > 0) {
                sectionsList.textContent = modifiedSections.join(', ');
            } else {
                sectionsList.textContent = 'No sections modified';
            }

            // Update improvement
            const improvementEl = document.getElementById('stat-improvement');
            improvementEl.textContent = improvement > 0 ? `+${improvement}%` : `${improvement}%`;
            improvementEl.className = improvement > 0 ? 'stat-highlight' : 'stat-value';
            document.getElementById('stat-improvement-detail').textContent = improvementDetail;

            // Show the stats panel
            statsPanel.style.display = 'grid';
        }

        // Function to format contact line with clickable LinkedIn/GitHub links
        function formatContactWithLinks(contactLine) {
            if (!contactLine) return '';

            // Regular expression to find LinkedIn and GitHub URLs
            // Matches: LinkedIn: https://linkedin.com/in/username or LinkedIn: linkedin.com/in/username
            // Matches: GitHub: https://github.com/username or GitHub: github.com/username
            const linkedinPattern = /(LinkedIn:\s*)(https?:\/\/)?(www\.)?(linkedin\.com\/[^\s|,;]+)/gi;
            const githubPattern = /(GitHub:\s*)(https?:\/\/)?(www\.)?(github\.com\/[^\s|,;]+)/gi;

            let formatted = escapeHtml(contactLine);

            // Replace LinkedIn links
            formatted = formatted.replace(linkedinPattern, (match, label, protocol, www, path) => {
                const url = (protocol || 'https://') + (www || '') + path;
                return `${label}<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: #FDC500; text-decoration: underline;">${url}</a>`;
            });

            // Replace GitHub links
            formatted = formatted.replace(githubPattern, (match, label, protocol, www, path) => {
                const url = (protocol || 'https://') + (www || '') + path;
                return `${label}<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: #FDC500; text-decoration: underline;">${url}</a>`;
            });

            return formatted;
        }

        // Professional Resume Parser - extracts structured data from resume text
        function parseResumeText(resumeText) {
            if (!resumeText) return null;

            const lines = resumeText.split('\n').map(l => l.trim()).filter(l => l);
            const parsed = {
                name: '',
                title: '',
                contact: [],
                sections: []
            };

            let currentSection = null;
            let currentSubsection = null;

            // Common section headers
            const sectionHeaders = [
                'SUMMARY', 'PROFESSIONAL SUMMARY', 'PROFILE', 'OBJECTIVE',
                'EXPERIENCE', 'WORK EXPERIENCE', 'PROFESSIONAL EXPERIENCE', 'EMPLOYMENT HISTORY',
                'SKILLS', 'TECHNICAL SKILLS', 'CORE COMPETENCIES', 'EXPERTISE',
                'EDUCATION', 'ACADEMIC BACKGROUND',
                'CERTIFICATIONS', 'CERTIFICATES', 'PROFESSIONAL CERTIFICATIONS',
                'PROJECTS', 'KEY PROJECTS',
                'ACHIEVEMENTS', 'ACCOMPLISHMENTS',
                'AWARDS', 'HONORS'
            ];

            // Extract name (usually first non-empty line)
            if (lines.length > 0) {
                parsed.name = lines[0];
            }

            // Parse through lines
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                const upperLine = line.toUpperCase();

                // Check if line is a section header
                const isSection = sectionHeaders.some(header => upperLine === header || upperLine === header + ':');

                if (isSection) {
                    // Start new section
                    currentSection = {
                        title: line.replace(':', '').trim(),
                        type: upperLine.replace(':', '').trim(),
                        content: [],
                        subsections: []
                    };
                    parsed.sections.push(currentSection);
                    currentSubsection = null;
                }
                // Check for job title / company (usually has dates or | separator)
                else if (line.includes('|') || /\d{4}/.test(line) || /\d{1,2}\/\d{4}/.test(line)) {
                    // Likely a job header or date line
                    if (currentSection && (currentSection.type.includes('EXPERIENCE') || currentSection.type.includes('EDUCATION'))) {
                        currentSubsection = {
                            header: line,
                            bullets: []
                        };
                        currentSection.subsections.push(currentSubsection);
                    } else if (currentSection) {
                        currentSection.content.push(line);
                    } else {
                        // Contact info or title
                        if (i === 1 || i === 2) {
                            if (line.includes('@') || line.includes('|') || /\d{3}/.test(line)) {
                                parsed.contact.push(line);
                            } else {
                                parsed.title = line;
                            }
                        }
                    }
                }
                // Check for bullet points (must start with bullet marker)
                else if (line.match(/^[-*]\s/)) {
                    const cleanLine = line.replace(/^[-*]\s*/, '');
                    if (currentSubsection) {
                        currentSubsection.bullets.push(cleanLine);
                    } else if (currentSection) {
                        currentSection.content.push(cleanLine);
                    }
                }
                // Lines in experience subsections (continued bullets without markers)
                else if (currentSubsection && currentSection && currentSection.type.includes('EXPERIENCE') && line.length > 30) {
                    currentSubsection.bullets.push(line);
                }
                // Regular content
                else {
                    if (!parsed.title && i <= 3 && !line.includes('@')) {
                        parsed.title = line;
                    } else if (i <= 3 && (line.includes('@') || line.includes('|') || /\d{3}/.test(line))) {
                        parsed.contact.push(line);
                    } else if (currentSection) {
                        currentSection.content.push(line);
                    }
                }
            }

            return parsed;
        }

        // Professional Resume Formatter - creates clean HTML from JSON or text
        function formatOptimizedResumeProfessional(resumeText) {
            let parsed;

            // Try to parse as JSON first
            try {
                // Clean the text - remove markdown code blocks if present
                let cleanText = resumeText.trim();
                if (cleanText.startsWith('```json')) {
                    cleanText = cleanText.replace(/^```json\s*/, '').replace(/```\s*$/, '');
                } else if (cleanText.startsWith('```')) {
                    cleanText = cleanText.replace(/^```\s*/, '').replace(/```\s*$/, '');
                }

                parsed = JSON.parse(cleanText);
                console.log('Successfully parsed JSON resume:', parsed);
            } catch (e) {
                // Fallback to text parsing
                console.log('JSON parse failed, falling back to text parsing:', e);
                parsed = parseResumeText(resumeText);
            }

            if (!parsed) return '<p style="color: #666;">No resume content available</p>';

            let html = '<div style="font-family: \'Inter\', -apple-system, sans-serif; color: #000; line-height: 1.6; max-width: 100%; padding: 2rem; background: #fff; border-radius: 8px;">';

            // Header Section
            html += '<div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 1rem; margin-bottom: 1.5rem;">';

            // Name
            if (parsed.name) {
                html += `<h1 style="margin: 0 0 0.5rem 0; font-size: 2rem; font-weight: 700; color: #000; letter-spacing: 0.5px;">${escapeHtml(parsed.name)}</h1>`;
            }

            // Title
            if (parsed.title) {
                html += `<div style="font-size: 1.1rem; font-weight: 500; color: #333; margin-bottom: 0.5rem;">${escapeHtml(parsed.title)}</div>`;
            }

            // Contact
            if (parsed.contact.length > 0) {
                html += '<div style="font-size: 0.95rem; color: #555;">';
                parsed.contact.forEach(contact => {
                    html += `<span style="margin: 0 0.5rem;">${escapeHtml(contact)}</span>`;
                });
                html += '</div>';
            }

            html += '</div>';

            // Check if this is JSON format (has summary field) or parsed text format (has sections array)
            const isJSONFormat = parsed.summary !== undefined && !parsed.sections;

            if (isJSONFormat) {
                // Handle JSON format directly

                // Summary Section
                if (parsed.summary) {
                    html += '<div style="margin-bottom: 1.5rem;">';
                    html += '<h2 style="font-size: 1.2rem; font-weight: 700; color: #000; text-transform: uppercase; margin: 0 0 0.75rem 0; padding-bottom: 0.25rem; border-bottom: 1px solid #ddd; letter-spacing: 0.5px;">SUMMARY</h2>';
                    html += `<p style="margin: 0 0 0.75rem 0; color: #333; line-height: 1.7; text-align: justify;">${escapeHtml(parsed.summary)}</p>`;
                    html += '</div>';
                }

                // Skills Section
                if (parsed.skills) {
                    html += '<div style="margin-bottom: 1.5rem;">';
                    html += '<h2 style="font-size: 1.2rem; font-weight: 700; color: #000; text-transform: uppercase; margin: 0 0 0.75rem 0; padding-bottom: 0.25rem; border-bottom: 1px solid #ddd; letter-spacing: 0.5px;">SKILLS</h2>';

                    for (const [category, skills] of Object.entries(parsed.skills)) {
                        html += `<div style="margin-bottom: 0.75rem;"><strong style="color: #000;">${escapeHtml(category)}:</strong> `;
                        html += skills.map(skill => escapeHtml(skill)).join(', ');
                        html += '</div>';
                    }
                    html += '</div>';
                }

                // Experience Section
                if (parsed.experience && parsed.experience.length > 0) {
                    html += '<div style="margin-bottom: 1.5rem;">';
                    html += '<h2 style="font-size: 1.2rem; font-weight: 700; color: #000; text-transform: uppercase; margin: 0 0 0.75rem 0; padding-bottom: 0.25rem; border-bottom: 1px solid #ddd; letter-spacing: 0.5px;">EXPERIENCE</h2>';

                    parsed.experience.forEach(job => {
                        html += '<div style="margin-bottom: 1.25rem;">';
                        html += `<div style="margin-bottom: 0.5rem;"><strong style="font-size: 1.05rem; color: #000;">${escapeHtml(job.company)}, ${escapeHtml(job.location)} | ${escapeHtml(job.dates)} | ${escapeHtml(job.title)}</strong></div>`;

                        if (job.bullets && job.bullets.length > 0) {
                            job.bullets.forEach(bullet => {
                                html += `<div style="margin-left: 1.5rem; margin-bottom: 0.4rem; position: relative; color: #333; line-height: 1.6;">
                                    <span style="position: absolute; left: -1.5rem; color: #000;"></span>
                                    ${escapeHtml(bullet)}
                                </div>`;
                            });
                        }
                        html += '</div>';
                    });
                    html += '</div>';
                }

                // Education Section
                if (parsed.education && parsed.education.length > 0) {
                    html += '<div style="margin-bottom: 1.5rem;">';
                    html += '<h2 style="font-size: 1.2rem; font-weight: 700; color: #000; text-transform: uppercase; margin: 0 0 0.75rem 0; padding-bottom: 0.25rem; border-bottom: 1px solid #ddd; letter-spacing: 0.5px;">EDUCATION</h2>';

                    parsed.education.forEach(edu => {
                        html += `<div style="margin-bottom: 0.5rem;">${escapeHtml(edu.degree)}: ${escapeHtml(edu.institution)}, ${escapeHtml(edu.location)}</div>`;
                    });
                    html += '</div>';
                }

                // Projects Section
                if (parsed.projects && parsed.projects.length > 0) {
                    html += '<div style="margin-bottom: 1.5rem;">';
                    html += '<h2 style="font-size: 1.2rem; font-weight: 700; color: #000; text-transform: uppercase; margin: 0 0 0.75rem 0; padding-bottom: 0.25rem; border-bottom: 1px solid #ddd; letter-spacing: 0.5px;">PROJECTS</h2>';

                    parsed.projects.forEach(project => {
                        html += '<div style="margin-bottom: 1.25rem;">';
                        html += `<div style="margin-bottom: 0.5rem;"><strong style="font-size: 1.05rem; color: #000;">${escapeHtml(project.name)} | ${escapeHtml(project.technologies)} | ${escapeHtml(project.date)}</strong></div>`;

                        if (project.bullets && project.bullets.length > 0) {
                            project.bullets.forEach(bullet => {
                                html += `<div style="margin-left: 1.5rem; margin-bottom: 0.4rem; position: relative; color: #333; line-height: 1.6;">
                                    <span style="position: absolute; left: -1.5rem; color: #000;"></span>
                                    ${escapeHtml(bullet)}
                                </div>`;
                            });
                        }
                        html += '</div>';
                    });
                    html += '</div>';
                }

                // Certifications Section
                if (parsed.certifications && parsed.certifications.length > 0) {
                    html += '<div style="margin-bottom: 1.5rem;">';
                    html += '<h2 style="font-size: 1.2rem; font-weight: 700; color: #000; text-transform: uppercase; margin: 0 0 0.75rem 0; padding-bottom: 0.25rem; border-bottom: 1px solid #ddd; letter-spacing: 0.5px;">CERTIFICATIONS</h2>';

                    parsed.certifications.forEach(cert => {
                        html += `<div style="margin-bottom: 0.5rem; color: #333;"> ${escapeHtml(cert)}</div>`;
                    });
                    html += '</div>';
                }

                // Awards Section
                if (parsed.awards && parsed.awards.length > 0) {
                    html += '<div style="margin-bottom: 1.5rem;">';
                    html += '<h2 style="font-size: 1.2rem; font-weight: 700; color: #000; text-transform: uppercase; margin: 0 0 0.75rem 0; padding-bottom: 0.25rem; border-bottom: 1px solid #ddd; letter-spacing: 0.5px;">AWARDS & HONORS</h2>';

                    parsed.awards.forEach(award => {
                        html += `<div style="margin-bottom: 0.5rem; color: #333;"> ${escapeHtml(award)}</div>`;
                    });
                    html += '</div>';
                }

                // Publications Section
                if (parsed.publications && parsed.publications.length > 0) {
                    html += '<div style="margin-bottom: 1.5rem;">';
                    html += '<h2 style="font-size: 1.2rem; font-weight: 700; color: #000; text-transform: uppercase; margin: 0 0 0.75rem 0; padding-bottom: 0.25rem; border-bottom: 1px solid #ddd; letter-spacing: 0.5px;">PUBLICATIONS</h2>';

                    parsed.publications.forEach(pub => {
                        html += `<div style="margin-bottom: 0.5rem; color: #333;"> ${escapeHtml(pub)}</div>`;
                    });
                    html += '</div>';
                }

                // Volunteer Section
                if (parsed.volunteer && parsed.volunteer.length > 0) {
                    html += '<div style="margin-bottom: 1.5rem;">';
                    html += '<h2 style="font-size: 1.2rem; font-weight: 700; color: #000; text-transform: uppercase; margin: 0 0 0.75rem 0; padding-bottom: 0.25rem; border-bottom: 1px solid #ddd; letter-spacing: 0.5px;">VOLUNTEER WORK</h2>';

                    parsed.volunteer.forEach(vol => {
                        html += `<div style="margin-bottom: 0.5rem; color: #333;"> ${escapeHtml(vol)}</div>`;
                    });
                    html += '</div>';
                }
            } else {
                // Handle parsed text format (fallback)
                parsed.sections.forEach(section => {
                html += '<div style="margin-bottom: 1.5rem;">';

                // Section Header
                html += `<h2 style="font-size: 1.2rem; font-weight: 700; color: #000; text-transform: uppercase; margin: 0 0 0.75rem 0; padding-bottom: 0.25rem; border-bottom: 1px solid #ddd; letter-spacing: 0.5px;">${escapeHtml(section.title)}</h2>`;

                // Section Content
                if (section.content.length > 0) {
                    // Special handling for SUMMARY/PROFILE sections - combine into one paragraph
                    if (section.type.includes('SUMMARY') || section.type.includes('PROFILE') || section.type.includes('OBJECTIVE')) {
                        const summaryText = section.content.join(' ');
                        html += `<p style="margin: 0 0 0.75rem 0; color: #333; line-height: 1.7; text-align: justify;">${escapeHtml(summaryText)}</p>`;
                    } else {
                        section.content.forEach(content => {
                            // Check if it's a skill list (comma-separated)
                            if (content.includes(',') && content.split(',').length > 3) {
                                // Format as skill tags
                                html += '<div style="margin-bottom: 0.5rem;">';
                                content.split(',').forEach(skill => {
                                    html += `<span style="display: inline-block; background: #f0f0f0; padding: 0.25rem 0.75rem; margin: 0.25rem; border-radius: 4px; font-size: 0.9rem; color: #333;">${escapeHtml(skill.trim())}</span>`;
                                });
                                html += '</div>';
                            } else if (content.startsWith('-') || content.startsWith('')) {
                                // Bullet point
                                html += `<div style="margin-left: 1.5rem; margin-bottom: 0.5rem; position: relative;">
                                    <span style="position: absolute; left: -1.5rem;"></span>
                                    ${escapeHtml(content.replace(/^[-]\s*/, ''))}
                                </div>`;
                            } else {
                                // Regular paragraph
                                html += `<p style="margin: 0 0 0.75rem 0; color: #333; line-height: 1.7;">${escapeHtml(content)}</p>`;
                            }
                        });
                    }
                }

                // Subsections (for Experience/Education)
                section.subsections.forEach(subsection => {
                    html += '<div style="margin-bottom: 1.25rem;">';

                    // Subsection header (job title, company, dates)
                    html += `<div style="margin-bottom: 0.5rem;">
                        <strong style="font-size: 1.05rem; color: #000;">${escapeHtml(subsection.header)}</strong>
                    </div>`;

                    // Bullets
                    if (subsection.bullets.length > 0) {
                        subsection.bullets.forEach(bullet => {
                            html += `<div style="margin-left: 1.5rem; margin-bottom: 0.4rem; position: relative; color: #333; line-height: 1.6;">
                                <span style="position: absolute; left: -1.5rem; color: #000;"></span>
                                ${escapeHtml(bullet)}
                            </div>`;
                        });
                    }

                    html += '</div>';
                });

                html += '</div>';
            });
            } // Close else block for parsed text format

            html += '</div>';
            return html;
        }

        // Function to highlight differences between original and optimized resume
        function formatResumeWithHighlights(originalText, optimizedText) {
            if (!optimizedText) return '';
            if (!originalText) return formatResumeForDisplay(optimizedText);

            // First, format the optimized resume normally
            const formattedHtml = formatResumeForDisplay(optimizedText);

            // Split into lines for comparison
            const originalLines = originalText.split('\n').map(l => l.trim()).filter(l => l);
            const optimizedLines = optimizedText.split('\n').map(l => l.trim()).filter(l => l);

            // Create a set of original lines for quick lookup
            const originalLineSet = new Set(originalLines);
            const originalLineMap = new Map();
            originalLines.forEach((line) => {
                const key = line.toLowerCase().substring(0, 50); // Use first 50 chars as key
                if (!originalLineMap.has(key)) {
                    originalLineMap.set(key, []);
                }
                originalLineMap.get(key).push(line);
            });

            // Create maps for additions and modifications
            const addedLineIndices = new Set();
            const modifiedLineIndices = new Set();

            optimizedLines.forEach((optLine, optIdx) => {
                const optKey = optLine.toLowerCase().substring(0, 50);
                const isExactMatch = originalLineSet.has(optLine);

                if (isExactMatch) {
                    // Line exists exactly - no change
                    return;
                }

                // Check if it's a modification of an existing line
                const isSimilarMatch = originalLineMap.has(optKey) &&
                    originalLineMap.get(optKey).some(origLine => {
                        // Check if lines are similar (at least 50% word overlap)
                        const origWords = new Set(origLine.toLowerCase().split(/\s+/));
                        const optWords = new Set(optLine.toLowerCase().split(/\s+/));
                        const intersection = new Set([...origWords].filter(x => optWords.has(x)));
                        const union = new Set([...origWords, ...optWords]);
                        return intersection.size / union.size > 0.5;
                    });

                // Classify as addition or modification
                if (isSimilarMatch) {
                    modifiedLineIndices.add(optIdx);
                } else {
                    addedLineIndices.add(optIdx);
                }
            });

            // Now, add highlights to the formatted HTML
            // We'll split the HTML by div tags and add highlights to changed lines
            const htmlLines = formattedHtml.split('</div>');
            let highlightedHtml = '';
            let lineIndex = 0;

            htmlLines.forEach((htmlLine, htmlIdx) => {
                if (htmlLine.trim()) {
                    // Check if this is a header element (name, contact, title) - don't highlight these
                    const isHeader = htmlLine.includes('resume-header-name') ||
                                   htmlLine.includes('resume-header-contact') ||
                                   htmlLine.includes('resume-header-title');

                    // Check if this line is added or modified AND is not a header
                    if (!isHeader) {
                        if (addedLineIndices.has(lineIndex)) {
                            // New content - green highlight
                            const highlighted = htmlLine.replace(
                                /<div class="([^"]+)">/,
                                '<div class="$1 resume-added" title="New content added">'
                            );
                            highlightedHtml += highlighted + '</div>';
                        } else if (modifiedLineIndices.has(lineIndex)) {
                            // Modified content - yellow highlight
                            const highlighted = htmlLine.replace(
                                /<div class="([^"]+)">/,
                                '<div class="$1 resume-modified" title="Modified from original">'
                            );
                            highlightedHtml += highlighted + '</div>';
                        } else {
                            highlightedHtml += htmlLine + '</div>';
                        }
                    } else {
                        highlightedHtml += htmlLine + '</div>';
                    }
                    lineIndex++;
                } else {
                    highlightedHtml += htmlLine;
                }
            });

            return highlightedHtml;
        }

        // Helper function to normalize text for content comparison (ignore formatting)
        function normalizeContent(text) {
            return text
                .toLowerCase()
                .replace(/[^\w\s]/g, ' ') // Remove punctuation
                .replace(/\s+/g, ' ')     // Normalize whitespace
                .trim();
        }

        // Helper function to extract meaningful words (filter out common words)
        function extractKeyWords(text) {
            const commonWords = new Set(['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'from', 'as', 'is', 'was', 'were', 'been', 'be', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'should', 'could', 'may', 'might', 'can']);
            return text
                .split(/\s+/)
                .filter(word => word.length > 2 && !commonWords.has(word));
        }

        // Wrapper function to handle JSON and apply highlighting (content changes only)
        function formatOptimizedWithHighlights(originalText, optimizedJson) {
            if (!optimizedJson) return '';

            // First, format the JSON to HTML
            const formattedHtml = formatOptimizedResumeProfessional(optimizedJson);

            if (!originalText) return formattedHtml;

            // Extract text content from the formatted HTML for comparison
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = formattedHtml;
            const optimizedText = tempDiv.textContent || tempDiv.innerText || '';

            // Normalize the entire original text and create a set of all content words
            const originalNormalized = normalizeContent(originalText);
            const originalWords = new Set(extractKeyWords(originalNormalized));

            // Parse the HTML and add highlighting classes
            const parser = new DOMParser();
            const doc = parser.parseFromString(formattedHtml, 'text/html');

            // Find all content-bearing elements (paragraphs, list items, divs with substantial text)
            const contentElements = doc.querySelectorAll('p, li, div');
            contentElements.forEach(element => {
                const text = element.textContent.trim();
                if (!text || text.length < 15) return; // Skip empty or very short content

                // Normalize and extract key words from this element
                const normalized = normalizeContent(text);
                const currentWords = extractKeyWords(normalized);

                // Check if this content has new/different meaningful words
                const newWords = currentWords.filter(word => !originalWords.has(word));
                const changedWords = currentWords.filter(word => originalWords.has(word));

                // Calculate what percentage of meaningful content is new
                const totalMeaningfulWords = currentWords.length;
                const newWordPercentage = totalMeaningfulWords > 0 ? (newWords.length / totalMeaningfulWords) : 0;

                // Only highlight if there's substantial new content (>30% new meaningful words)
                if (newWordPercentage > 0.3 && totalMeaningfulWords >= 3) {
                    // Check if it's a modification (some original words present) or completely new
                    if (changedWords.length > 0 && changedWords.length >= newWords.length * 0.3) {
                        element.classList.add('resume-modified'); // Modified content (yellow)
                    } else if (newWords.length >= 3) {
                        element.classList.add('resume-added'); // New content (green)
                    }
                }
            });

            return doc.body.innerHTML;
        }

        function formatResumeForDisplay(resumeText) {
            if (!resumeText) return '';

            const mainSections = ['CONTACT', 'PROFESSIONAL SUMMARY', 'SUMMARY', 'OBJECTIVE', 'EXPERIENCE',
                'WORK EXPERIENCE', 'EDUCATION', 'SKILLS', 'TECHNICAL SKILLS', 'CERTIFICATIONS',
                'PROJECTS', 'ACADEMIC PROJECTS', 'SCHOOL PROJECTS', 'PERSONAL PROJECTS',
                'SIDE PROJECTS', 'PORTFOLIO PROJECTS', 'CAPSTONE PROJECTS', 'RESEARCH PROJECTS',
                'INDIVIDUAL PROJECTS', 'TEAM PROJECTS', 'GROUP PROJECTS', 'COURSE PROJECTS',
                'UNIVERSITY PROJECTS', 'COLLEGE PROJECTS', 'ACHIEVEMENTS', 'AWARDS',
                'PUBLICATIONS', 'LANGUAGES', 'REFERENCES'];

            // Helper function to check if a section is a project section
            function isProjectSection(sectionText) {
                return sectionText.toUpperCase().includes('PROJECT');
            }

            const lines = resumeText.split('\n').filter(l => l.trim()); // Remove empty lines
            let html = '';
            let prevType = null;
            let lineIndex = 0;
            let headerProcessed = false;
            let currentSection = null;  // Track current section (EXPERIENCE, PROJECTS, etc.)
            let contactAdded = false;  // Track if contact info has been added to prevent duplicates

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                if (!line) continue;

                // Detect header section with explicit 3-line format:
                // Line 1: Name
                // Line 2: Professional Title
                // Line 3: Contact info (with | separators)
                if (!headerProcessed && i < 3 && !mainSections.includes(line.toUpperCase()) &&
                    !line.toUpperCase().includes('SUMMARY') && !line.toUpperCase().includes('EXPERIENCE') &&
                    !line.toUpperCase().includes('SKILLS') && !line.toUpperCase().includes('EDUCATION')) {

                    // Check if it's contact info (has | or email/phone/linkedin/github keywords)
                    const isContactInfo = line.includes('|') ||
                        (line.includes('@') && (line.includes('.com') || line.includes('.edu') || line.includes('.net'))) ||
                        line.match(/\(\d{3}\)[\s-]?\d{3}[\s-]?\d{4}/) ||  // Phone pattern
                        line.toLowerCase().includes('linkedin.com') ||
                        line.toLowerCase().includes('github.com') ||
                        line.toLowerCase().includes('email:') ||
                        line.toLowerCase().includes('phone:');

                    // Line 0: Name (first non-contact line)
                    if (i === 0 && !isContactInfo) {
                        html += `<div class="resume-header-name">${escapeHtml(line)}</div>`;
                        prevType = 'header_name';
                        continue;
                    }
                    // Line 1: Professional Title (second line, not contact info)
                    else if (i === 1 && prevType === 'header_name' && !isContactInfo) {
                        html += `<div class="resume-header-title">${escapeHtml(line)}</div>`;
                        prevType = 'header_title';
                        continue;
                    }
                    // Line 2: Contact Info (third line with contact patterns)
                    else if (i === 2 && prevType === 'header_title' && isContactInfo && !contactAdded) {
                        const contactWithLinks = formatContactWithLinks(line);
                        html += `<div class="resume-header-contact">${contactWithLinks}</div>`;
                        prevType = 'header_contact';
                        contactAdded = true;
                        headerProcessed = true;
                        continue;
                    }
                    // Fallback: If pattern doesn't match, mark header as done
                    else {
                        headerProcessed = true;
                        // Don't skip this line, process it below
                    }
                }

                // If header is processed, continue with normal processing
                if (headerProcessed || i >= 5) {
                    // Skip duplicate contact info lines (if contact was already added in header)
                    const isContactInfo = line.includes('|') ||
                        line.toLowerCase().includes('location:') ||
                        line.toLowerCase().includes('email:') ||
                        line.toLowerCase().includes('phone:') ||
                        line.toLowerCase().includes('linkedin:') ||
                        line.toLowerCase().includes('github:') ||
                        line.toLowerCase().includes('linkedin.com') ||
                        line.toLowerCase().includes('github.com');

                    // If this looks like contact info and we've already added it, skip it
                    if (isContactInfo && contactAdded && i < 10) {
                        continue;  // Skip this line
                    }

                    // Main section headers (SKILLS, EXPERIENCE, etc.)
                    const lineUpper = line.toUpperCase();
                    if (mainSections.includes(lineUpper) || (line.toUpperCase() === line && line.split(' ').length <= 3 && !line.endsWith(':'))) {
                        html += `<div class="resume-main-section">${escapeHtml(line)}</div>`;
                        prevType = 'main_section';
                        // Normalize all project section variations to 'PROJECTS'
                        if (isProjectSection(lineUpper)) {
                            currentSection = 'PROJECTS';
                        } else {
                            currentSection = lineUpper;
                        }
                        headerProcessed = true;
                    }
                    // Also check if it's a project section variation (contains "PROJECT")
                    else if (isProjectSection(line) && (line.toUpperCase() === line || lineUpper === line)) {
                        html += `<div class="resume-main-section">${escapeHtml(line)}</div>`;
                        prevType = 'main_section';
                        currentSection = 'PROJECTS';  // Normalize to 'PROJECTS'
                        headerProcessed = true;
                    }
                    // Category headers (Data Engineering:, Cloud & Big Data:, etc.)
                    else if (line.endsWith(':') && line.toUpperCase() !== line && line.length < 60) {
                        html += `<div class="resume-category">${escapeHtml(line)}</div>`;
                        prevType = 'category';
                        headerProcessed = true;
                    }
                    // Project entry: If we're in PROJECTS section, detect project names
                    // Project names are typically:
                    // - Lines that come right after PROJECTS section header
                    // - OR lines with "|" separator (Project Name | Technologies | Date)
                    // - NOT lines ending with ":" (like "Technologies:", "Status:")
                    else if (currentSection === 'PROJECTS' && !line.match(/^[\-\*]\s/)) {
                        // Check if it's not a section header
                        if (!mainSections.includes(line.toUpperCase())) {
                            // Check if it's a project name:
                            // 1. Line with "|" separator
                            // 2. Line that comes right after PROJECTS section (first line after header)
                            // 3. Line that comes after bullet points (new project after previous project's bullets)
                            // 4. Line that doesn't end with ":" (not "Technologies:", "Status:", etc.)
                            // 5. Line that doesn't start with common metadata keywords
                            const isMetadata = /^(technologies|status|duration|date|tools|stack):/i.test(line);
                            // Check if it looks like a project name (not too long, doesn't have common words)
                            const looksLikeProjectName = (
                                !line.endsWith(':') &&
                                !isMetadata &&
                                line.split(' ').length <= 5 &&  // Project names are usually short
                                !/developed|built|created|designed|implemented/i.test(line)  // Not a description
                            );
                            if (line.includes('|') ||
                                (prevType === 'main_section' && looksLikeProjectName) ||
                                (prevType === 'bullet' && looksLikeProjectName) ||  // New project after bullets
                                (prevType === 'project_entry' && line.includes('|'))) {
                                html += `<div class="resume-project-entry">${escapeHtml(line)}</div>`;
                                prevType = 'project_entry';
                                headerProcessed = true;
                            } else {
                                // If it's metadata or something else, handle normally
                                html += `<div class="resume-normal">${escapeHtml(line)}</div>`;
                                prevType = 'normal';
                                headerProcessed = true;
                            }
                        } else {
                            html += `<div class="resume-normal">${escapeHtml(line)}</div>`;
                            prevType = 'normal';
                            headerProcessed = true;
                        }
                    }
                    // Experience entry: Contains "|" and date patterns (Company, Location | Dates | Job Title)
                    else if (line.includes('|') && (/\d{4}|\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{4}/i.test(line) || prevType === 'main_section') && !line.match(/^[\-\*]\s/)) {
                        // Parse experience entry to style parts differently
                        // Format: "Company, Location | Dates | Job Title"
                        const parts = line.split('|').map(p => p.trim());
                        let formattedLine = '';

                        if (parts.length >= 3) {
                            // Company and Location (11pt Bold)
                            formattedLine += `<span class="resume-company">${escapeHtml(parts[0])}</span>`;
                            formattedLine += ` <span style="font-size: 10pt; font-weight: 400;">|</span> `;
                            // Dates (10pt Regular)
                            formattedLine += `<span class="resume-date">${escapeHtml(parts[1])}</span>`;
                            formattedLine += ` <span style="font-size: 10pt; font-weight: 400;">|</span> `;
                            // Job Title (11pt Regular)
                            formattedLine += `<span class="resume-job-title">${escapeHtml(parts[2])}</span>`;
                        } else if (parts.length === 2) {
                            // Fallback: if only 2 parts, assume first is company, second is dates
                            formattedLine += `<span class="resume-company">${escapeHtml(parts[0])}</span>`;
                            formattedLine += ` <span style="font-size: 10pt; font-weight: 400;">|</span> `;
                            formattedLine += `<span class="resume-date">${escapeHtml(parts[1])}</span>`;
                        } else {
                            // Fallback: just use the line as is with bold
                            formattedLine = `<span class="resume-company">${escapeHtml(line)}</span>`;
                        }

                        html += `<div class="resume-experience-entry">${formattedLine}</div>`;
                        prevType = 'experience_entry';
                        headerProcessed = true;
                    }
                    // Bullet points
                    else if (line.match(/^[\-\*]\s/)) {
                        const bulletText = line.replace(/^[\-\*]\s*/, '');
                        html += `<div class="resume-bullet">${escapeHtml(bulletText)}</div>`;
                        prevType = 'bullet';
                        headerProcessed = true;
                    }
                    // Regular text
                    else {
                        html += `<div class="resume-normal">${escapeHtml(line)}</div>`;
                        prevType = 'normal';
                        headerProcessed = true;
                    }
                }
            }

            return html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showMessage(text, type = 'success') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message message-${type} show`;
            setTimeout(() => {
                messageEl.classList.remove('show');
            }, 5000);
        }

        function displayScoreComparison(comparison) {
            const card = document.getElementById('score-comparison-card');
            const content = document.getElementById('score-comparison-content');
            const summaryDiv = document.getElementById('score-comparison-summary');

            const originalScore = comparison.original_score || 0;
            const newScore = comparison.new_score || 0;
            const improvement = comparison.improvement || 0;
            const improvementPercent = comparison.improvement_percent || 0;
            const status = comparison.status || 'no_change';
            const statusMessage = comparison.status_message || 'No Change';

            // Determine color based on status
            let statusColor = '#10b981'; // Green for improvement
            if (status === 'no_change') statusColor = '#6b7280'; // Gray
            else if (status === 'decreased') statusColor = '#ef4444'; // Red
            else if (status === 'minor_improvement') statusColor = '#f59e0b'; // Yellow

            // Populate clean summary at the top
            const summaryHTML = `
                <div style="display: inline-flex; align-items: center; gap: 2rem; background: rgba(104, 42, 83, 0.1); padding: 2rem 3rem; border-radius: 16px; border: 2px solid ${statusColor};">
                    <div style="text-align: center;">
                        <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">Before</div>
                        <div style="font-size: 3rem; font-weight: 800; color: var(--text);">${originalScore}%</div>
                    </div>
                    <div style="font-size: 3rem; color: ${statusColor};"></div>
                    <div style="text-align: center;">
                        <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">After</div>
                        <div style="font-size: 3rem; font-weight: 800; color: ${statusColor};">${newScore}%</div>
                    </div>
                </div>
                <div style="margin-top: 1.5rem; font-size: 1.3rem; font-weight: 600; color: ${statusColor};">
                    ${improvement >= 0 ? '+' : ''}${improvement} points ${improvement >= 0 ? '' : ''}
                </div>
                <div style="font-size: 1rem; color: var(--text-muted); margin-top: 0.5rem;">
                    ${statusMessage}
                </div>
            `;
            summaryDiv.innerHTML = summaryHTML;

            const html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 1.5rem;">
                    <div>
                        <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">Before Optimization</div>
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--text);">${originalScore}%</div>
                        <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-top: 0.5rem; overflow: hidden;">
                            <div style="width: ${originalScore}%; height: 100%; background: linear-gradient(90deg, #682A53, #8a3a6d); transition: width 0.5s;"></div>
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">After Optimization</div>
                        <div style="font-size: 2.5rem; font-weight: 700; color: ${statusColor};">${newScore}%</div>
                        <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-top: 0.5rem; overflow: hidden;">
                            <div style="width: ${newScore}%; height: 100%; background: linear-gradient(90deg, #10b981, #34d399); transition: width 0.5s;"></div>
                        </div>
                    </div>
                </div>
                <div style="text-align: center; padding: 1.5rem; background: rgba(104, 42, 83, 0.1); border-radius: 12px; border: 2px solid ${statusColor};">
                    <div style="font-size: 1.2rem; font-weight: 600; color: ${statusColor}; margin-bottom: 0.5rem;">
                        ${improvement >= 0 ? '+' : ''}${improvement}% ${improvement >= 0 ? '' : ''}
                    </div>
                    <div style="font-size: 0.95rem; color: var(--text-muted);">
                        ${statusMessage}
                    </div>
                    ${improvementPercent > 0 ? `<div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem;">${improvementPercent.toFixed(1)}% relative improvement</div>` : ''}
                </div>
            `;

            content.innerHTML = html;
            card.style.display = 'block';
        }

        function displaySectionBreakdown(breakdown) {
            const card = document.getElementById('section-breakdown-card');
            const content = document.getElementById('section-breakdown-content');

            const sectionsImproved = breakdown.sections_improved || 0;
            const improvements = breakdown.improvements || [];

            if (improvements.length === 0) {
                card.style.display = 'none';
                return;
            }

            let html = `
                <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 4px solid #10b981;">
                    <div style="font-size: 1.1rem; font-weight: 600; color: #10b981; margin-bottom: 0.25rem;">
                        ${sectionsImproved} Section${sectionsImproved !== 1 ? 's' : ''} Improved
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
            `;

            improvements.forEach(imp => {
                html += `
                    <div style="padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 3px solid #FDC500;">
                        <div style="font-weight: 600; color: #FDC500; margin-bottom: 0.5rem; font-size: 1rem;">
                            ${imp.section}
                        </div>
                        <div style="color: var(--text); margin-bottom: 0.5rem;">
                            ${imp.improvement}
                        </div>
                        ${imp.keywords_added && imp.keywords_added.length > 0 ? `
                            <div style="font-size: 0.85rem; color: var(--text-muted);">
                                Keywords added: <span style="color: #10b981; font-weight: 500;">${imp.keywords_added.join(', ')}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            html += '</div>';
            content.innerHTML = html;
            card.style.display = 'block';
        }

        function displayAdditionalSuggestions(additional) {
            const card = document.getElementById('additional-suggestions-card');
            const content = document.getElementById('additional-suggestions-content');

            const provider = additional.provider || 'alternative provider';
            const suggestions = additional.suggestions || [];
            const message = additional.message || 'Additional suggestions:';

            if (suggestions.length === 0) {
                card.style.display = 'none';
                return;
            }

            let html = `
                <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(245, 158, 11, 0.1); border-radius: 8px;">
                    <div style="font-size: 0.95rem; color: var(--text);">
                        ${message}
                    </div>
                </div>
                <ul style="list-style: none; padding: 0; margin: 0;">
            `;

            suggestions.forEach((suggestion, index) => {
                html += `
                    <li style="padding: 0.75rem; margin-bottom: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 6px; border-left: 3px solid var(--warning);">
                        <span style="color: var(--warning); font-weight: 600; margin-right: 0.5rem;">${index + 1}.</span>
                        <span style="color: var(--text);">${suggestion}</span>
                    </li>
                `;
            });

            html += '</ul>';
            content.innerHTML = html;
            card.style.display = 'block';
        }

        // Analytics & Insights Functions
        function toggleAnalyticsSection() {
            const content = document.getElementById('analytics-insights-content');
            const icon = document.getElementById('analytics-toggle-icon');

            content.classList.toggle('expanded');
            icon.classList.toggle('expanded');
        }

        // Resume Preview Functions
        function toggleResumePreview() {
            const resumeContent = document.getElementById('optimized-resume');
            const expandBtn = document.getElementById('resume-expand-btn');
            const expandText = document.getElementById('resume-expand-text');
            const icon = expandBtn.querySelector('i');

            resumeContent.classList.toggle('preview-mode');

            if (resumeContent.classList.contains('preview-mode')) {
                expandText.textContent = 'Show Full Resume';
                icon.className = 'fas fa-chevron-down';
                expandBtn.classList.remove('expanded');
            } else {
                expandText.textContent = 'Show Less';
                icon.className = 'fas fa-chevron-up';
                expandBtn.classList.add('expanded');
            }
        }

        // Polish Section Toggle
        function togglePolishSection() {
            const content = document.getElementById('polish-actions-list');
            const icon = document.getElementById('polish-toggle-icon');

            content.classList.toggle('expanded');
            icon.classList.toggle('expanded');
        }

        function switchAnalyticsTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.analytics-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.analytics-tab-content').forEach(content => content.classList.remove('active'));

            // Add active class to selected tab and content
            event.target.closest('.analytics-tab').classList.add('active');
            document.getElementById(`analytics-tab-${tabName}`).classList.add('active');
        }

        function displayAnalytics(analytics) {
            if (!analytics) return;

            const card = document.getElementById('analytics-insights-card');

            // Display change explanations
            displayChangeExplanations(analytics.change_explanations);

            // Display keyword analysis
            displayKeywordAnalysis(analytics.keyword_analysis);

            // Display section scores
            displaySectionScores(analytics.section_scores);

            // Display improvement suggestions
            displayImprovementSuggestions(analytics.improvement_suggestions);

            // Display industry benchmark
            displayIndustryBenchmark(analytics.industry_benchmark);

            // Show the card
            card.style.display = 'block';
        }

        function displayChangeExplanations(changes) {
            const content = document.getElementById('analytics-tab-changes');
            if (!changes || changes.length === 0) {
                content.innerHTML = '<p style="color: var(--text); opacity: 0.7;">No significant changes detected.</p>';
                return;
            }

            let showingAll = false;

            function renderChanges(showAll) {
                const changesToShow = showAll ? changes : changes.slice(0, 3);
                let html = '<h4 style="color: var(--text); margin-bottom: 1rem;">What We Changed and Why</h4>';
                html += '<div id="changesListContainer">';

                changesToShow.forEach(change => {
                    const impactClass = `${change.impact}-impact`;
                    html += `
                        <div class="analytics-item ${impactClass}">
                            <div class="analytics-item-header">
                                <div class="analytics-item-title">
                                    <i class="fas fa-${getChangeIcon(change.type)}"></i> ${escapeHtml(change.change)}
                                </div>
                                <span class="analytics-item-badge ${change.impact}">${change.impact} impact</span>
                            </div>
                            <div class="analytics-item-desc">${escapeHtml(change.section)} Section</div>
                            <div class="analytics-item-reason">${escapeHtml(change.reason)}</div>
                        </div>
                    `;
                });

                html += '</div>';

                // Add Show More/Less button if there are more than 3 changes
                if (changes.length > 3) {
                    const buttonText = showAll ? 'Show Less' : `Show More (${changes.length - 3} more)`;
                    html += `
                        <button id="toggleChangesBtn" style="
                            margin-top: 1rem;
                            padding: 0.75rem 1.5rem;
                            background: #682A53;
                            color: #FDC500;
                            border: none;
                            border-radius: 8px;
                            font-size: 0.9rem;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s;
                            width: 100%;
                            box-shadow: 0 4px 12px rgba(104, 42, 83, 0.3);
                        " onmouseover="this.style.background='#7d3463'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(104, 42, 83, 0.5)'"
                           onmouseout="this.style.background='#682A53'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(104, 42, 83, 0.3)'"
                            <i class="fas fa-${showAll ? 'chevron-up' : 'chevron-down'}"></i> ${buttonText}
                        </button>
                    `;
                }

                content.innerHTML = html;

                // Attach click handler to toggle button
                const toggleBtn = document.getElementById('toggleChangesBtn');
                if (toggleBtn) {
                    toggleBtn.onclick = () => {
                        showingAll = !showingAll;
                        renderChanges(showingAll);
                    };
                }
            }

            // Initial render showing only 3 changes
            renderChanges(false);
        }

        function displayKeywordAnalysis(analysis) {
            const content = document.getElementById('analytics-tab-keywords');
            if (!analysis) {
                content.innerHTML = '<p style="color: var(--text); opacity: 0.7;">Keyword analysis not available.</p>';
                return;
            }

            let html = '<h4 style="color: var(--text); margin-bottom: 1rem;">Keyword Optimization</h4>';

            // Added keywords
            if (analysis.added_keywords && analysis.added_keywords.length > 0) {
                html += '<div style="margin-bottom: 1.5rem;">';
                html += '<h5 style="color: var(--success); margin-bottom: 0.75rem;"><i class="fas fa-plus-circle"></i> Keywords Added</h5>';
                html += '<div class="keyword-heatmap">';

                analysis.added_keywords.forEach(keyword => {
                    html += `
                        <div class="keyword-item">
                            <div class="keyword-name">${escapeHtml(keyword)}</div>
                            <div class="keyword-count">${analysis.keyword_density[keyword] ? analysis.keyword_density[keyword].toFixed(2) + '%' : 'New'}</div>
                        </div>
                    `;
                });

                html += '</div></div>';
            }

            // Keyword heatmap by section
            if (analysis.heatmap) {
                html += '<div style="margin-top: 1.5rem;">';
                html += '<h5 style="color: var(--primary); margin-bottom: 0.75rem;"><i class="fas fa-fire"></i> Keyword Distribution</h5>';

                for (const [section, keywords] of Object.entries(analysis.heatmap)) {
                    if (Object.keys(keywords).length > 0) {
                        html += `<div style="margin-bottom: 1rem;">`;
                        html += `<strong style="color: var(--text);">${section}:</strong> `;

                        const keywordTags = Object.entries(keywords).map(([kw, count]) =>
                            `<span style="background: rgba(104,42,83,0.2); color: var(--primary); padding: 0.25rem 0.5rem; border-radius: 0.25rem; margin: 0.25rem; display: inline-block; font-size: 0.85rem;">${escapeHtml(kw)} (${count})</span>`
                        ).join(' ');

                        html += keywordTags;
                        html += `</div>`;
                    }
                }

                html += '</div>';
            }

            // Total matched keywords
            html += `<div style="margin-top: 1.5rem; padding: 1rem; background: rgba(46,213,115,0.1); border-radius: 0.5rem;">`;
            html += `<strong style="color: var(--success);">Total Job-Relevant Keywords Matched: ${analysis.total_matched_keywords || 0}</strong>`;
            html += `</div>`;

            content.innerHTML = html;
        }

        function displaySectionScores(scores) {
            const content = document.getElementById('analytics-tab-scores');
            if (!scores) {
                content.innerHTML = '<p style="color: var(--text); opacity: 0.7;">Section scores not available.</p>';
                return;
            }

            let html = '<h4 style="color: var(--text); margin-bottom: 1rem;">Section-by-Section Performance</h4>';
            html += '<div class="section-score-grid">';

            for (const [section, score] of Object.entries(scores)) {
                if (score > 0) {  // Only show sections that exist
                    html += `
                        <div class="section-score-card">
                            <div class="section-score-name">${section.charAt(0) + section.slice(1).toLowerCase()}</div>
                            <div class="section-score-value">${score}<span style="font-size: 1.5rem; opacity: 0.7;">%</span></div>
                            <div class="section-score-bar">
                                <div class="section-score-fill" style="width: ${score}%;"></div>
                            </div>
                        </div>
                    `;
                }
            }

            html += '</div>';
            content.innerHTML = html;
        }

        function displayImprovementSuggestions(suggestions) {
            const content = document.getElementById('analytics-tab-suggestions');
            if (!suggestions || suggestions.length === 0) {
                content.innerHTML = '<p style="color: var(--text); opacity: 0.7;">No additional suggestions at this time.</p>';
                return;
            }

            let html = '<h4 style="color: var(--text); margin-bottom: 1rem;">Actionable Recommendations</h4>';

            suggestions.forEach((suggestion, index) => {
                const priorityColor = suggestion.priority === 'high' ? 'var(--success)' : suggestion.priority === 'medium' ? 'var(--primary)' : '#666';
                html += `
                    <div class="analytics-item" style="border-left-color: ${priorityColor};">
                        <div class="analytics-item-header">
                            <div class="analytics-item-title">
                                <i class="fas fa-${suggestion.category === 'keywords' ? 'key' : suggestion.category === 'ats' ? 'robot' : 'edit'}"></i>
                                ${index + 1}. ${escapeHtml(suggestion.suggestion)}
                            </div>
                            <span class="analytics-item-badge ${suggestion.priority}">${suggestion.priority}</span>
                        </div>
                        <div class="analytics-item-reason">${escapeHtml(suggestion.example)}</div>
                    </div>
                `;
            });

            content.innerHTML = html;
        }

        function displayIndustryBenchmark(benchmark) {
            const content = document.getElementById('analytics-tab-benchmark');
            if (!benchmark) {
                content.innerHTML = '<p style="color: var(--text); opacity: 0.7;">Benchmark data not available.</p>';
                return;
            }

            const comparisonText = benchmark.comparison === 'above_average' ? 'Above Average' :
                                 benchmark.comparison === 'average' ? 'Average' : 'Below Average';
            const comparisonColor = benchmark.comparison === 'above_average' ? 'var(--success)' :
                                   benchmark.comparison === 'average' ? 'var(--primary)' : 'var(--warning)';

            let html = '<h4 style="color: var(--text); margin-bottom: 1rem;">Industry Benchmark Comparison</h4>';

            html += `
                <div class="benchmark-card">
                    <div class="benchmark-header">
                        <div class="benchmark-percentile">${benchmark.percentile}<span style="font-size: 1.5rem; opacity: 0.7;">th</span></div>
                        <div style="font-size: 1rem; color: var(--text); opacity: 0.7; margin-top: 0.5rem;">Percentile</div>
                        <div class="benchmark-comparison" style="color: ${comparisonColor};">
                            <i class="fas fa-${benchmark.comparison === 'above_average' ? 'arrow-up' : benchmark.comparison === 'average' ? 'minus' : 'arrow-down'}"></i>
                            ${comparisonText}
                        </div>
                        <div style="margin-top: 0.5rem; color: var(--text); opacity: 0.7;">for ${escapeHtml(benchmark.role)}</div>
                        <div style="margin-top: 1rem; font-size: 1.1rem; color: var(--success);">
                            <strong>${benchmark.improvement_percentage}% stronger</strong> than when you started
                        </div>
                    </div>

                    ${benchmark.strengths && benchmark.strengths.length > 0 ? `
                    <div class="benchmark-strengths">
                        <h5 style="color: var(--success); margin-bottom: 0.75rem;"><i class="fas fa-check-circle"></i> Key Strengths</h5>
                        <ul class="benchmark-list">
                            ${benchmark.strengths.map(s => `<li>${escapeHtml(s)}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}

                    ${benchmark.areas_to_improve && benchmark.areas_to_improve.length > 0 ? `
                    <div class="benchmark-improvements">
                        <h5 style="color: var(--primary); margin-bottom: 0.75rem;"><i class="fas fa-arrow-trend-up"></i> Areas for Improvement</h5>
                        <ul class="benchmark-list">
                            ${benchmark.areas_to_improve.map(a => `<li>${escapeHtml(a)}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                </div>
            `;

            content.innerHTML = html;
        }

        function getChangeIcon(type) {
            switch (type) {
                case 'keyword_addition': return 'plus-circle';
                case 'content_enhancement': return 'magic';
                case 'quantification': return 'chart-line';
                case 'formatting': return 'align-left';
                default: return 'edit';
            }
        }

        // Global variables to store original uploaded file for rendering
        let originalResumeFile = null;
        let originalResumeFileType = null;
        let originalResumeFileName = null;

        async function handleResumeUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Store the original file in memory for later rendering
            originalResumeFile = file;
            originalResumeFileName = file.name;

            // Determine file type
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (fileExtension === 'pdf') {
                originalResumeFileType = 'pdf';
            } else if (fileExtension === 'docx' || fileExtension === 'doc') {
                originalResumeFileType = 'docx';
            } else {
                originalResumeFileType = 'text'; // For TXT files
            }

            console.log('File stored in memory:', originalResumeFileName, 'Type:', originalResumeFileType);

            const filenameEl = document.getElementById('resume-filename');
            filenameEl.innerHTML = `<i class="fas fa-file"></i> ${file.name}`;
            filenameEl.style.display = 'inline-flex';

            document.getElementById('loading').classList.add('show');
            document.getElementById('loading').querySelector('p').textContent = 'Uploading and parsing resume...';

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/upload-resume', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                document.getElementById('loading').classList.remove('show');

                if (data.success) {
                    const resumeText = data.resume_text || '';
                    document.getElementById('resume-text').value = resumeText;
                    // Update global variable
                    currentResumeText = resumeText;
                    showMessage('Resume uploaded and parsed successfully!', 'success');
                    console.log('Resume uploaded successfully, length:', resumeText.length);
                } else {
                    showMessage('Error: ' + (data.error || 'Failed to parse resume'), 'error');
                    filenameEl.style.display = 'none';
                    console.error('Upload error:', data.error);
                    // Clear stored file on error
                    originalResumeFile = null;
                    originalResumeFileType = null;
                    originalResumeFileName = null;
                }
            } catch (error) {
                document.getElementById('loading').classList.remove('show');
                showMessage('Error uploading resume: ' + error.message, 'error');
                filenameEl.style.display = 'none';
                // Clear stored file on error
                originalResumeFile = null;
                originalResumeFileType = null;
                originalResumeFileName = null;
            }
        }

        // Function to render original PDF file with formatting
        async function renderPDFOriginal(file, containerElement) {
            try {
                // Clear container and show loading
                containerElement.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);"><i class="fas fa-spinner fa-spin"></i> Loading PDF...</div>';

                // Configure PDF.js worker
                if (typeof pdfjsLib !== 'undefined') {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                }

                // Read file as array buffer
                const arrayBuffer = await file.arrayBuffer();

                // Load PDF
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                console.log('PDF loaded, pages:', pdf.numPages);

                // Clear loading message
                containerElement.innerHTML = '';

                // Render each page
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const viewport = page.getViewport({ scale: 1.5 });

                    // Create canvas for this page
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    canvas.style.width = '100%';
                    canvas.style.height = 'auto';
                    canvas.style.marginBottom = '1rem';
                    canvas.style.border = '1px solid rgba(104, 42, 83, 0.2)';
                    canvas.style.borderRadius = '8px';

                    // Render page
                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };
                    await page.render(renderContext).promise;

                    // Add page to container
                    containerElement.appendChild(canvas);
                }

                console.log('PDF rendering complete');
            } catch (error) {
                console.error('Error rendering PDF:', error);
                containerElement.innerHTML = `<div style="color: var(--danger); padding: 1rem;">Error rendering PDF: ${error.message}</div>`;
            }
        }

        // Function to render original DOCX file with formatting
        async function renderDOCXOriginal(file, containerElement) {
            try {
                // Clear container and show loading
                containerElement.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);"><i class="fas fa-spinner fa-spin"></i> Loading Word document...</div>';

                // Read file as array buffer
                const arrayBuffer = await file.arrayBuffer();

                // Convert DOCX to HTML using mammoth
                const result = await mammoth.convertToHtml({ arrayBuffer: arrayBuffer });
                console.log('DOCX converted to HTML');

                // Style the HTML output
                const styledHTML = `
                    <div style="
                        font-family: inherit;
                        font-size: 1rem;
                        line-height: 1.8;
                        color: var(--text);
                        background: rgba(255, 255, 255, 0.06);
                        padding: 1.5rem;
                        border-radius: 12px;
                        border: 2px solid rgba(104, 42, 83, 0.3);
                    ">
                        ${result.value}
                    </div>
                `;

                containerElement.innerHTML = styledHTML;

                // Log any conversion warnings
                if (result.messages && result.messages.length > 0) {
                    console.log('DOCX conversion warnings:', result.messages);
                }
            } catch (error) {
                console.error('Error rendering DOCX:', error);
                containerElement.innerHTML = `<div style="color: var(--danger); padding: 1rem;">Error rendering Word document: ${error.message}</div>`;
            }
        }

        // Master function to render original resume based on file type
        async function renderOriginalResume() {
            const containerElement = document.getElementById('original-resume');

            // Check if container element exists (it might not be visible yet)
            if (!containerElement) {
                console.log('Original resume container not found, skipping render');
                return;
            }

            if (!originalResumeFile || !originalResumeFileType) {
                // Fallback to text display if no file is stored
                containerElement.textContent = currentOriginalResumeText || currentResumeText || '';
                containerElement.style.whiteSpace = 'pre-wrap';
                containerElement.style.wordWrap = 'break-word';
                console.log('No original file stored, displaying as text');
                return;
            }

            console.log('Rendering original resume:', originalResumeFileName, 'Type:', originalResumeFileType);

            if (originalResumeFileType === 'pdf') {
                await renderPDFOriginal(originalResumeFile, containerElement);
            } else if (originalResumeFileType === 'docx') {
                await renderDOCXOriginal(originalResumeFile, containerElement);
            } else {
                // For text files, display as plain text
                containerElement.textContent = currentOriginalResumeText || currentResumeText || '';
                containerElement.style.whiteSpace = 'pre-wrap';
                containerElement.style.wordWrap = 'break-word';
            }
        }

        // Store providers globally for status checking
        let availableProviders = {};

        // Load available providers on page load
        async function loadProviders() {
            try {
                const response = await fetch('/api/providers');
                const data = await response.json();
                if (data.success) {
                    const select = document.getElementById('ai-provider');
                    select.innerHTML = '';

                    // Store availability info
                    data.providers.forEach(provider => {
                        availableProviders[provider.id] = provider;

                        const option = document.createElement('option');
                        option.value = provider.id;
                        option.textContent = `${provider.name} - ${provider.description}`;
                        option.style.background = 'var(--bg-card)';
                        option.style.color = 'var(--text)';
                        if (!provider.available) {
                            option.textContent += ' (API Key Required)';
                            option.style.opacity = '0.7';
                        }
                        select.appendChild(option);
                    });
                    updateProviderStatus();
                }
            } catch (error) {
                console.error('Error loading providers:', error);
            }
        }

        function updateProviderStatus() {
            const select = document.getElementById('ai-provider');
            const statusDiv = document.getElementById('provider-status');
            const selectedProvider = select.value;

            const provider = availableProviders[selectedProvider];

            if (provider && provider.available) {
                // API key is configured - show clean status
                statusDiv.innerHTML = `<i class="fas fa-check-circle" style="color: var(--success);"></i> AI Provider: ${provider.name}`;
            } else if (provider) {
                // API key NOT configured - show warning
                const providerKeyMap = {
                    'groq': 'GROQ_API_KEY',
                    'openai': 'OPENAI_API_KEY',
                    'claude': 'ANTHROPIC_API_KEY',
                    'gemini': 'GEMINI_API_KEY',
                    'cohere': 'COHERE_API_KEY'
                };
                const keyName = providerKeyMap[selectedProvider] || 'API_KEY';
                statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i> Configure ${keyName} to use ${provider.name}`;
            } else {
                // Fallback
                statusDiv.innerHTML = `<i class="fas fa-robot"></i> AI Provider: ${selectedProvider}`;
            }
        }

        // Load providers and apply template styling when page loads
        window.addEventListener('DOMContentLoaded', function() {
            loadProviders();
            // Apply default template styling (only to optimized resume)
            applyTemplateStyling();
        });

        async function analyzeResume() {
            // Get resume text from textarea or use currentResumeText if set
            let resumeText = document.getElementById('resume-text').value.trim();
            if (!resumeText && typeof currentResumeText !== 'undefined' && currentResumeText) {
                resumeText = currentResumeText;
            }

            const jobDescription = document.getElementById('job-description').value.trim();
            const provider = document.getElementById('ai-provider').value;

            if (!resumeText || !jobDescription) {
                showMessage('Please upload/paste resume and enter job description', 'error');
                console.error('Missing data:', { resumeText: !!resumeText, jobDescription: !!jobDescription });
                return;
            }

            console.log('Analyzing resume...', { resumeLength: resumeText.length, jobLength: jobDescription.length });

            currentResumeText = resumeText;
            currentJobDescription = jobDescription;

            // Show loading state on button
            const analyzeBtn = document.getElementById('analyze-btn');
            const originalBtnHTML = analyzeBtn.innerHTML;
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
            analyzeBtn.style.opacity = '0.7';
            analyzeBtn.style.cursor = 'not-allowed';

            document.getElementById('loading').classList.add('show');
            startLoadingMessages(); // Start rotating messages
            document.getElementById('results').style.display = 'none';
            document.getElementById('optimization-results').style.display = 'none';

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resume_text: resumeText,
                        job_description: jobDescription,
                        provider: provider
                    })
                });

                const data = await response.json();

                // Hide loading and restore button
                stopLoadingMessages(); // Stop rotating messages
                document.getElementById('loading').classList.remove('show');
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = originalBtnHTML;
                analyzeBtn.style.opacity = '1';
                analyzeBtn.style.cursor = 'pointer';

                if (!data.success) {
                    showMessage('Error: ' + (data.error || 'Unknown error'), 'error');
                    return;
                }

                displayAnalysisResults(data);

                // Display ATS analysis if available
                if (data.ats_analysis) {
                    displayATSAnalysis(data.ats_analysis);
                }

                // Show suggestions card (user can load suggestions on demand)
                document.getElementById('suggestions-card').style.display = 'block';

            } catch (error) {
                // Hide loading and restore button on error
                stopLoadingMessages(); // Stop rotating messages
                document.getElementById('loading').classList.remove('show');
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = originalBtnHTML;
                analyzeBtn.style.opacity = '1';
                analyzeBtn.style.cursor = 'pointer';

                showMessage('Error analyzing resume: ' + error.message, 'error');
            }
        }

        function displayATSAnalysis(atsData) {
            const card = document.getElementById('ats-analysis-card');
            const content = document.getElementById('ats-analysis-content');

            if (!atsData || !atsData.ats_score) {
                card.style.display = 'none';
                return;
            }

            const score = atsData.ats_score;
            const grade = atsData.ats_grade || 'N/A';
            const status = atsData.ats_status || 'Unknown';
            const summary = atsData.summary || {};
            const recommendations = atsData.recommendations || [];

            // Determine color based on score
            let scoreColor = '#ef4444'; // Red
            if (score >= 80) scoreColor = '#10b981'; // Green
            else if (score >= 70) scoreColor = '#3b82f6'; // Blue
            else if (score >= 60) scoreColor = '#f59e0b'; // Yellow
            else if (score >= 50) scoreColor = '#f97316'; // Orange

            let html = `
                <div style="text-align: center; padding: 1.5rem; background: rgba(104, 42, 83, 0.1); border-radius: 12px; margin-bottom: 1rem;">
                    <div style="font-size: 2.5rem; font-weight: 700; color: ${scoreColor}; margin-bottom: 0.5rem;">
                        ${score}%
                    </div>
                    <div style="font-size: 1.5rem; font-weight: 600; color: ${scoreColor}; margin-bottom: 0.25rem;">
                        Grade: ${grade}
                    </div>
                    <div style="font-size: 1rem; color: var(--text-muted);">
                        ${status}
                    </div>
                </div>
            `;

            // Summary stats
            if (summary.required_keywords_total > 0) {
                const requiredPct = ((summary.required_keywords_found || 0) / summary.required_keywords_total * 100).toFixed(1);
                html += `
                    <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <div style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem;">
                            <i class="fas fa-keywords" style="color: #FDC500;"></i> Keyword Coverage
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-muted);">Required Keywords:</span>
                            <span style="color: var(--text); font-weight: 600;">${summary.required_keywords_found || 0} / ${summary.required_keywords_total}</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                            <div style="width: ${requiredPct}%; height: 100%; background: ${requiredPct >= 70 ? '#10b981' : requiredPct >= 50 ? '#f59e0b' : '#ef4444'}; transition: width 0.3s;"></div>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">
                            ${requiredPct}% coverage
                        </div>
                    </div>
                `;
            }

            // Recommendations
            if (recommendations.length > 0) {
                html += `
                    <div style="margin-top: 1rem;">
                        <div style="font-weight: 600; color: var(--text); margin-bottom: 0.75rem;">
                            <i class="fas fa-list-check" style="color: #FDC500;"></i> Top Recommendations
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                `;

                recommendations.slice(0, 5).forEach((rec, idx) => {
                    // Handle both object and string formats
                    const recObj = typeof rec === 'string' ? { message: rec, category: 'General', priority: 'medium' } : rec;
                    const priority = recObj.priority || 'low';
                    const category = recObj.category || 'General';
                    const message = recObj.message || recObj || '';
                    const priorityColor = priority === 'high' ? '#ef4444' : priority === 'medium' ? '#f59e0b' : '#3b82f6';
                    html += `
                        <div style="padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 3px solid ${priorityColor};">
                            <div style="display: flex; align-items: start; gap: 0.5rem;">
                                <span style="color: ${priorityColor}; font-weight: 600; min-width: 60px; font-size: 0.85rem; text-transform: uppercase;">${priority}</span>
                                <div style="flex: 1;">
                                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">${category}</div>
                                    <div style="color: var(--text);">${message}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            content.innerHTML = html;
            card.style.display = 'block';
        }

        function displayAnalysisResults(data) {
            const score = data.match_score;
            currentOriginalScore = score;  // Store original score for comparison

            const scoreCircle = document.getElementById('score-circle');
            const scoreValue = document.getElementById('score-value');
            const scoreMessage = document.getElementById('score-message');
            const scoreDescription = document.getElementById('score-description');

            // Animate score
            let currentScore = 0;
            const increment = score / 30;
            const timer = setInterval(() => {
                currentScore += increment;
                if (currentScore >= score) {
                    currentScore = score;
                    clearInterval(timer);
                }
                scoreValue.textContent = Math.round(currentScore) + '%';
            }, 30);

            scoreCircle.className = 'score-circle ';
            if (score >= 70) {
                scoreCircle.classList.add('score-high');
                scoreMessage.textContent = 'Great Match!';
                scoreDescription.textContent = 'Your resume is well-matched with this job. No optimization needed!';
            } else if (score >= 50) {
                scoreCircle.classList.add('score-medium');
                scoreMessage.textContent = 'Good Match';
                scoreDescription.textContent = 'Your resume matches well, but could be improved.';
            } else {
                scoreCircle.classList.add('score-low');
                scoreMessage.textContent = 'Needs Improvement';
                scoreDescription.textContent = 'Your resume needs optimization to better match this job.';
            }

            // Display potential score
            const potentialScore = data.potential_score || score;
            document.getElementById('potential-score').textContent = `${potentialScore}/100`;

            // Display score breakdown
            displayScoreBreakdown(data.score_breakdown || {});

            // Display categorized actions
            displayCategorizedActions(data.categorized_actions || []);

            // Display strengths (collapsible)
            const strengthsList = document.getElementById('strengths-list');
            strengthsList.innerHTML = data.strengths.map(s =>
                `<li><i class="fas fa-check"></i> <span>${s}</span></li>`
            ).join('');

            // Store suggestions for optimization (button is always visible in new design)
            if (data.show_optimization || data.content_suggestions) {
                currentSuggestions = data.content_suggestions || [];
            }

            // Show the optimize button (it's always visible now, no need to toggle)
            const optimizationSection = document.getElementById('optimization-section-inline');
            if (optimizationSection) {
                optimizationSection.style.display = 'block';
            }

            document.getElementById('results').style.display = 'block';
            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });

            // Show provider info if available
            if (data.provider || data.analysis?.provider) {
                const providerName = data.provider || data.analysis?.provider || 'selected model';
                showMessage(`Resume analyzed using ${providerName}!`, 'success');
            }
        }

        function displayScoreBreakdown(breakdown) {
            const container = document.getElementById('score-breakdown-items');
            if (!breakdown || Object.keys(breakdown).length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Score breakdown not available</p>';
                return;
            }

            const breakdownLabels = {
                'ats_compliance': { name: 'ATS Compliance', icon: 'fa-check-square' },
                'skills_match': { name: 'Skills Match', icon: 'fa-code' },
                'keywords': { name: 'Keywords', icon: 'fa-key' },
                'experience': { name: 'Experience', icon: 'fa-briefcase' },
                'clarity': { name: 'Clarity & Format', icon: 'fa-align-left' }
            };

            const html = Object.entries(breakdown).map(([key, value]) => {
                const label = breakdownLabels[key] || { name: key, icon: 'fa-circle' };
                const statusClass = value.status === 'good' ? 'status-good' : 'status-warning';
                const statusIcon = value.status === 'good' ? 'fa-check-circle' : 'fa-exclamation-triangle';
                const gainText = value.potential_gain > 0 ? `+${value.potential_gain} points` : 'Optimized';

                return `
                    <div class="breakdown-item ${statusClass}">
                        <div class="breakdown-item-left">
                            <span class="breakdown-item-icon"><i class="fas ${statusIcon}"></i></span>
                            <span class="breakdown-item-name">${label.name}</span>
                        </div>
                        <div class="breakdown-item-right">
                            <span class="breakdown-score">${value.score}/${value.max}</span>
                            ${value.potential_gain > 0 ? `<span class="breakdown-gain">${gainText}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function displayCategorizedActions(actions) {
            if (!actions || actions.length === 0) {
                return;
            }

            // Group actions by priority
            const critical = actions.filter(a => a.priority === 'critical');
            const highImpact = actions.filter(a => a.priority === 'high_impact');
            const polish = actions.filter(a => a.priority === 'polish');

            // Display each category
            displayActionCategory('critical', critical);
            displayActionCategory('high-impact', highImpact);
            displayActionCategory('polish', polish);
        }

        function displayActionCategory(category, actions) {
            const sectionId = `${category}-actions`;
            const listId = `${category}-actions-list`;

            const section = document.getElementById(sectionId);
            const list = document.getElementById(listId);

            if (!actions || actions.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            const html = actions.map(action => `
                <div class="action-item" data-action-id="${action.id}">
                    <div class="action-header">
                        <div class="action-title">${action.title}</div>
                        <div class="action-meta">
                            <span class="action-points">+${action.points}</span>
                        </div>
                    </div>
                </div>
            `).join('');

            list.innerHTML = html;
        }

        function toggleStrengths() {
            const content = document.getElementById('strengths-content');
            const icon = document.getElementById('strengths-toggle-icon');
            const header = document.querySelector('.collapsible-header');

            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
                header.classList.add('expanded');
            } else {
                content.style.display = 'none';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
                header.classList.remove('expanded');
            }
        }

        function toggleResultsDetails() {
            const detailedSection = document.getElementById('detailed-analysis');
            const toggleText = document.getElementById('details-toggle-text');

            if (detailedSection.style.display === 'none' || detailedSection.style.display === '') {
                detailedSection.style.display = 'block';
                toggleText.textContent = ' Hide Detailed Analysis';
            } else {
                detailedSection.style.display = 'none';
                toggleText.textContent = ' Show Detailed Analysis';
            }
        }

        function toggleOptimizationDetails() {
            const detailedSection = document.getElementById('detailed-optimization-analytics');
            const toggleText = document.getElementById('optimization-details-toggle-text');

            if (detailedSection.style.display === 'none' || detailedSection.style.display === '') {
                detailedSection.style.display = 'block';
                toggleText.textContent = ' Hide Detailed Analytics';
            } else {
                detailedSection.style.display = 'none';
                toggleText.textContent = ' Show Detailed Analytics';
            }
        }

        function displayATSAnalysis(atsData) {
            const card = document.getElementById('ats-analysis-card');
            const content = document.getElementById('ats-analysis-content');

            if (!atsData || !atsData.ats_score) {
                card.style.display = 'none';
                return;
            }

            const score = atsData.ats_score;
            const grade = atsData.ats_grade || 'N/A';
            const status = atsData.ats_status || 'Unknown';
            const summary = atsData.summary || {};
            const recommendations = atsData.recommendations || [];

            // Determine color based on score
            let scoreColor = '#ef4444'; // Red
            if (score >= 80) scoreColor = '#10b981'; // Green
            else if (score >= 70) scoreColor = '#3b82f6'; // Blue
            else if (score >= 60) scoreColor = '#f59e0b'; // Yellow
            else if (score >= 50) scoreColor = '#f97316'; // Orange

            let html = `
                <div style="text-align: center; padding: 1.5rem; background: rgba(104, 42, 83, 0.1); border-radius: 12px; margin-bottom: 1rem;">
                    <div style="font-size: 2.5rem; font-weight: 700; color: ${scoreColor}; margin-bottom: 0.5rem;">
                        ${score}%
                    </div>
                    <div style="font-size: 1.5rem; font-weight: 600; color: ${scoreColor}; margin-bottom: 0.25rem;">
                        Grade: ${grade}
                    </div>
                    <div style="font-size: 1rem; color: var(--text-muted);">
                        ${status}
                    </div>
                </div>
            `;

            // Summary stats
            if (summary.required_keywords_total > 0) {
                const requiredPct = ((summary.required_keywords_found || 0) / summary.required_keywords_total * 100).toFixed(1);
                html += `
                    <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <div style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem;">
                            <i class="fas fa-keywords" style="color: #FDC500;"></i> Keyword Coverage
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-muted);">Required Keywords:</span>
                            <span style="color: var(--text); font-weight: 600;">${summary.required_keywords_found || 0} / ${summary.required_keywords_total}</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                            <div style="width: ${requiredPct}%; height: 100%; background: ${requiredPct >= 70 ? '#10b981' : requiredPct >= 50 ? '#f59e0b' : '#ef4444'}; transition: width 0.3s;"></div>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">
                            ${requiredPct}% coverage
                        </div>
                    </div>
                `;
            }

            // Recommendations
            if (recommendations.length > 0) {
                html += `
                    <div style="margin-top: 1rem;">
                        <div style="font-weight: 600; color: var(--text); margin-bottom: 0.75rem;">
                            <i class="fas fa-list-check" style="color: #FDC500;"></i> Top Recommendations
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                `;

                recommendations.slice(0, 5).forEach((rec, idx) => {
                    const priorityColor = rec.priority === 'high' ? '#ef4444' : rec.priority === 'medium' ? '#f59e0b' : '#3b82f6';
                    const message = typeof rec === 'string' ? rec : rec.message;
                    const category = rec.category || 'General';
                    const priority = rec.priority || 'low';
                    html += `
                        <div style="padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 3px solid ${priorityColor};">
                            <div style="display: flex; align-items: start; gap: 0.5rem;">
                                <span style="color: ${priorityColor}; font-weight: 600; min-width: 60px; font-size: 0.85rem; text-transform: uppercase;">${priority}</span>
                                <div style="flex: 1;">
                                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">${category}</div>
                                    <div style="color: var(--text);">${message}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            content.innerHTML = html;
            card.style.display = 'block';
        }

        // Suggestions data variables already declared in global scope above

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function loadSuggestions() {
            const resumeText = document.getElementById('resume-text').value.trim();
            const jobDescription = document.getElementById('job-description').value.trim();
            const provider = document.getElementById('ai-provider').value;

            if (!resumeText || !jobDescription) {
                showMessage('Please provide resume and job description first', 'error');
                return;
            }

            const btn = document.getElementById('load-suggestions-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Suggestions...';

            try {
                const response = await fetch('/api/suggestions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resume_text: resumeText,
                        job_description: jobDescription,
                        provider: provider
                    })
                });

                const data = await response.json();
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sparkles"></i> Generate Smart Suggestions';

                if (!data.success) {
                    showMessage('Error: ' + (data.error || 'Failed to generate suggestions'), 'error');
                    return;
                }

                currentSuggestions = data.suggestions || [];
                suggestionMap = {};
                currentSuggestions.forEach(sug => {
                    suggestionMap[sug.id] = sug;
                });

                displaySuggestions(data);
                showMessage(`Generated ${data.summary.total} suggestions!`, 'success');

            } catch (error) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sparkles"></i> Generate Smart Suggestions';
                showMessage('Error loading suggestions: ' + error.message, 'error');
            }
        }

        function displaySuggestions(data) {
            const content = document.getElementById('suggestions-content');
            const summary = document.getElementById('suggestions-summary');
            const suggestions = data.suggestions || [];
            const summaryData = data.summary || {};

            // Display summary
            summary.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <div style="padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">${summaryData.total || 0}</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">Total Suggestions</div>
                    </div>
                    <div style="padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">${summaryData.auto_applied || 0}</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">Auto-Applied</div>
                    </div>
                    <div style="padding: 1rem; background: rgba(251, 191, 36, 0.1); border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #fbbf24;">${summaryData.medium_confidence || 0}</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">Need Review</div>
                    </div>
                    <div style="padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">${summaryData.needs_info || 0}</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted);">Need Info</div>
                    </div>
                </div>
            `;

            // Group suggestions by type
            const highConf = suggestions.filter(s => s.type === 'high');
            const mediumConf = suggestions.filter(s => s.type === 'medium');
            const needsInfo = suggestions.filter(s => s.type === 'needs_info');

            let html = '';

            // High confidence (auto-applied, but can be reviewed)
            if (highConf.length > 0) {
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: #10b981; margin-bottom: 1rem;">
                            <i class="fas fa-check-circle"></i> High Confidence (Auto-Applied)
                        </h4>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                `;
                highConf.slice(0, 10).forEach(sug => {
                    html += createSuggestionHTML(sug, true);
                });
                html += '</div></div>';
            }

            // Medium confidence (need approval)
            if (mediumConf.length > 0) {
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: #fbbf24; margin-bottom: 1rem;">
                            <i class="fas fa-exclamation-circle"></i> Medium Confidence (Review Needed)
                        </h4>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                `;
                mediumConf.slice(0, 15).forEach(sug => {
                    html += createSuggestionHTML(sug, false);
                });
                html += '</div></div>';
            }

            // Needs info
            if (needsInfo.length > 0) {
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: #3b82f6; margin-bottom: 1rem;">
                            <i class="fas fa-question-circle"></i> Needs Information
                        </h4>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                `;
                needsInfo.slice(0, 10).forEach(sug => {
                    html += createSuggestionHTML(sug, false, true);
                });
                html += '</div></div>';
            }

            content.innerHTML = html;
            document.getElementById('apply-suggestions-btn').style.display = acceptedSuggestionIds.size > 0 ? 'inline-block' : 'none';
        }

        function createSuggestionHTML(sug, isAutoApplied, isNeedsInfo = false) {
            const isAccepted = acceptedSuggestionIds.has(sug.id);
            const typeColor = sug.type === 'high' ? '#10b981' : sug.type === 'medium' ? '#fbbf24' : '#3b82f6';
            const impactStars = ''.repeat(sug.impact_score || 1) + ''.repeat(5 - (sug.impact_score || 1));

            let html = `
                <div id="sug-${sug.id}" style="padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; border-left: 4px solid ${typeColor}; ${isAccepted ? 'background: rgba(16, 185, 129, 0.15);' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 0.75rem; padding: 0.25rem 0.5rem; background: ${typeColor}20; color: ${typeColor}; border-radius: 4px; text-transform: uppercase; font-weight: 600;">
                                    ${sug.category || 'general'}
                                </span>
                                <span style="font-size: 0.75rem; color: var(--text-muted);">
                                    ${impactStars} Impact
                                </span>
                                ${isAutoApplied ? '<span style="font-size: 0.75rem; color: #10b981;"><i class="fas fa-check"></i> Auto-applied</span>' : ''}
                            </div>
                            
                            <div style="margin-bottom: 0.5rem;">
                                <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.25rem;">
                                    <span style="text-decoration: line-through; opacity: 0.7;">${escapeHtml(sug.original_text || '')}</span>
                                </div>
                                <div style="color: #FDC500; font-weight: 600; font-size: 1rem;">
                                    ${escapeHtml(sug.suggested_text || '')}
                                </div>
                            </div>
                            
                            ${sug.reasoning ? `
                                <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem; font-style: italic;">
                                    <i class="fas fa-lightbulb"></i> ${escapeHtml(sug.reasoning)}
                                </div>
                            ` : ''}
                            
                            ${isNeedsInfo && sug.alternatives ? `
                                <div style="margin-top: 0.5rem;">
                                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">Choose value:</div>
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        ${sug.alternatives.map(alt => `
                                            <button onclick="selectAlternative('${sug.id}', '${escapeHtml(alt)}')" 
                                                    style="padding: 0.25rem 0.75rem; background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6; border-radius: 4px; color: #3b82f6; cursor: pointer; font-size: 0.85rem;">
                                                ${escapeHtml(alt)}
                                            </button>
                                        `).join('')}
                                        <input type="text" id="custom-${sug.id}" placeholder="Custom" 
                                               style="padding: 0.25rem 0.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: var(--text); width: 100px; font-size: 0.85rem;">
                                        <button onclick="setCustomValue('${sug.id}')" 
                                                style="padding: 0.25rem 0.5rem; background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6; border-radius: 4px; color: #3b82f6; cursor: pointer; font-size: 0.85rem;">
                                            Set
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            ${!isAutoApplied ? `
                                <button onclick="toggleSuggestion('${sug.id}')" 
                                        style="padding: 0.5rem 1rem; background: ${isAccepted ? '#10b981' : 'rgba(255,255,255,0.1)'}; border: 1px solid ${isAccepted ? '#10b981' : 'rgba(255,255,255,0.2)'}; border-radius: 6px; color: ${isAccepted ? '#fff' : 'var(--text)'}; cursor: pointer;">
                                    <i class="fas fa-${isAccepted ? 'check' : 'plus'}"></i> ${isAccepted ? 'Accepted' : 'Accept'}
                                </button>
                            ` : ''}
                            <button onclick="rejectSuggestion('${sug.id}')" 
                                    style="padding: 0.5rem 1rem; background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 6px; color: #ef4444; cursor: pointer;">
                                <i class="fas fa-times"></i> Reject
                            </button>
                        </div>
                    </div>
                </div>
            `;
            return html;
        }

        function toggleSuggestion(sugId) {
            if (acceptedSuggestionIds.has(sugId)) {
                acceptedSuggestionIds.delete(sugId);
            } else {
                acceptedSuggestionIds.add(sugId);
            }
            updateSuggestionUI(sugId);
            document.getElementById('apply-suggestions-btn').style.display = acceptedSuggestionIds.size > 0 ? 'inline-block' : 'none';
        }

        function rejectSuggestion(sugId) {
            acceptedSuggestionIds.delete(sugId);
            const element = document.getElementById(`sug-${sugId}`);
            if (element) {
                element.style.opacity = '0.5';
                element.style.textDecoration = 'line-through';
            }
            document.getElementById('apply-suggestions-btn').style.display = acceptedSuggestionIds.size > 0 ? 'inline-block' : 'none';
        }

        function updateSuggestionUI(sugId) {
            const element = document.getElementById(`sug-${sugId}`);
            if (element) {
                const isAccepted = acceptedSuggestionIds.has(sugId);
                element.style.background = isAccepted ? 'rgba(16, 185, 129, 0.15)' : 'rgba(255,255,255,0.05)';
                const btn = element.querySelector('button');
                if (btn) {
                    btn.innerHTML = `<i class="fas fa-${isAccepted ? 'check' : 'plus'}"></i> ${isAccepted ? 'Accepted' : 'Accept'}`;
                    btn.style.background = isAccepted ? '#10b981' : 'rgba(255,255,255,0.1)';
                    btn.style.color = isAccepted ? '#fff' : 'var(--text)';
                }
            }
        }

        function selectAlternative(sugId, value) {
            if (suggestionMap[sugId]) {
                const original = suggestionMap[sugId].original_text;
                suggestionMap[sugId].suggested_text = original.replace(/\?/, value);
                suggestionMap[sugId].confidence = 0.7; // Increased confidence after user input
                displaySuggestions({ suggestions: currentSuggestions, summary: { total: currentSuggestions.length } });
            }
        }

        function setCustomValue(sugId) {
            const input = document.getElementById(`custom-${sugId}`);
            if (input && input.value) {
                selectAlternative(sugId, input.value);
            }
        }

        async function applyAcceptedSuggestions() {
            if (acceptedSuggestionIds.size === 0) {
                showMessage('No suggestions selected', 'error');
                return;
            }

            const resumeText = document.getElementById('resume-text').value.trim();
            const acceptedIds = Array.from(acceptedSuggestionIds);

            try {
                const response = await fetch('/api/apply-suggestions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resume_text: resumeText,
                        accepted_suggestions: acceptedIds,
                        suggestion_map: suggestionMap
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    showMessage('Error: ' + (data.error || 'Failed to apply suggestions'), 'error');
                    return;
                }

                // Update resume text
                document.getElementById('resume-text').value = data.updated_resume;
                currentResumeText = data.updated_resume;

                showMessage(`Applied ${data.applied_count} suggestions successfully!`, 'success');

                // Clear accepted suggestions
                acceptedSuggestionIds.clear();
                document.getElementById('apply-suggestions-btn').style.display = 'none';

            } catch (error) {
                showMessage('Error applying suggestions: ' + error.message, 'error');
            }
        }

        async function optimizeResume() {
            // Get current values from form if not set
            if (!currentResumeText || !currentJobDescription) {
                currentResumeText = document.getElementById('resume-text').value.trim();
                currentJobDescription = document.getElementById('job-description').value.trim();
            }

            if (!currentResumeText || !currentJobDescription) {
                showMessage('Please analyze your resume first', 'error');
                return;
            }

            // If no suggestions, get them from the displayed list or from analysis
            if (!currentSuggestions || currentSuggestions.length === 0) {
                // Try to get from suggestions list (intelligent suggestions)
                const suggestionsList = document.querySelectorAll('#suggestions-list li');
                if (suggestionsList.length > 0) {
                    // Extract suggestion text from the list items
                    currentSuggestions = Array.from(suggestionsList).map(li => {
                        const text = li.textContent.trim();
                        // If it's a structured suggestion, try to extract the suggested text
                        // Format might be: "Original text  Suggested text" or just "Suggested text"
                        if (text.includes('') || text.includes('->')) {
                            const parts = text.split(/|->/);
                            return parts.length > 1 ? parts[1].trim() : text;
                        }
                        return text;
                    });
                } else {
                    // Fallback: get from content suggestions if available
                    const suggestionsEl = document.getElementById('suggestions-list');
                    if (suggestionsEl && suggestionsEl.dataset.suggestions) {
                        try {
                            const storedSuggestions = JSON.parse(suggestionsEl.dataset.suggestions);
                            if (Array.isArray(storedSuggestions)) {
                                currentSuggestions = storedSuggestions.map(s => {
                                    if (typeof s === 'string') return s;
                                    if (s.suggested_text) return s.suggested_text;
                                    if (s.suggestion) return s.suggestion;
                                    if (s.text) return s.text;
                                    return String(s);
                                });
                            }
                        } catch (e) {
                            console.warn('Could not parse stored suggestions:', e);
                        }
                    }
                }
            }

            console.log('Optimizing resume...', {
                hasResume: !!currentResumeText,
                hasJobDesc: !!currentJobDescription,
                suggestionsCount: currentSuggestions.length
            });

            // Show loading state on button (try new button ID first, fall back to old)
            const optimizeBtn = document.getElementById('optimize-btn-main') || document.getElementById('optimize-btn');
            if (!optimizeBtn) {
                console.error('Optimize button not found');
                return;
            }
            const originalBtnHTML = optimizeBtn.innerHTML;
            optimizeBtn.disabled = true;
            optimizeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Optimizing...';
            optimizeBtn.style.opacity = '0.7';
            optimizeBtn.style.cursor = 'not-allowed';

            document.getElementById('loading').classList.add('show');
            startLoadingMessages(); // Start rotating messages
            startProgressAnimation(); // Start multi-stage progress

            try {
                const response = await fetch('/api/optimize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resume_text: currentResumeText,
                        job_description: currentJobDescription,
                        suggestions: currentSuggestions,
                        provider: document.getElementById('ai-provider').value,
                        original_score: currentOriginalScore,  // Pass original score for comparison
                        template: currentTemplate  // Pass selected template
                    })
                });

                const data = await response.json();

                // Hide loading and restore button
                stopLoadingMessages(); // Stop rotating messages
                stopProgressAnimation(); // Complete progress animation
                setTimeout(() => {
                    document.getElementById('loading').classList.remove('show');
                    resetProgress(); // Reset for next time
                }, 500);
                optimizeBtn.disabled = false;
                optimizeBtn.innerHTML = originalBtnHTML;
                optimizeBtn.style.opacity = '1';
                optimizeBtn.style.cursor = 'pointer';

                console.log('Optimize response:', data);

                if (!data.success) {
                    showMessage('Error: ' + (data.error || 'Unknown error'), 'error');
                    return;
                }

                // Store the original text for download
                currentOptimizedResumeText = data.optimized_resume || '';

                // Display score comparison if available
                if (data.score_comparison) {
                    displayScoreComparison(data.score_comparison);
                }

                // Display section breakdown if available
                if (data.section_breakdown) {
                    displaySectionBreakdown(data.section_breakdown);
                }

                // Display additional suggestions if score < 60%
                if (data.additional_suggestions) {
                    displayAdditionalSuggestions(data.additional_suggestions);
                }

                // Display analytics if available
                if (data.analytics) {
                    displayAnalytics(data.analytics);
                }

                // Store original resume text for comparison
                currentOriginalResumeText = data.original_resume || currentResumeText;

                // Display statistics panel
                displayStatistics(
                    currentOriginalResumeText,
                    currentOptimizedResumeText,
                    data.score_comparison
                );

                // Apply template styling before displaying
                applyTemplateStyling();

                // Format and display resumes with proper styling
                // Original resume: render with formatting if file was uploaded, otherwise display as text
                await renderOriginalResume();

                // Optimized resume: display cleanly without highlights
                document.getElementById('optimized-resume').innerHTML = formatOptimizedResumeProfessional(
                    data.optimized_resume || ''
                );

                // Show the expand button for resume preview
                document.getElementById('resume-expand-btn').style.display = 'flex';

                // Re-apply template styling after content is loaded
                applyTemplateStyling();
                document.getElementById('optimization-results').style.display = 'block';
                document.getElementById('download-section').style.display = 'flex';
                document.getElementById('optimization-results').scrollIntoView({ behavior: 'smooth', block: 'start' });

                const provider = data.provider || document.getElementById('ai-provider').value || 'selected provider';
                showMessage(`Resume optimized successfully using ${provider}!`, 'success');

            } catch (error) {
                console.error('Optimize error:', error);

                // Hide loading and restore button on error
                stopLoadingMessages(); // Stop rotating messages
                document.getElementById('loading').classList.remove('show');
                optimizeBtn.disabled = false;
                optimizeBtn.innerHTML = originalBtnHTML;
                optimizeBtn.style.opacity = '1';
                optimizeBtn.style.cursor = 'pointer';

                showMessage('Error optimizing resume: ' + error.message, 'error');
            }
        }

        // Export Preview Modal Functions
        function showExportPreview() {
            const format = document.getElementById('download-format').value;
            const formatNames = {
                'pdf': 'PDF',
                'docx': 'Word Document',
                'txt': 'Plain Text'
            };

            // Update format name in modal
            document.getElementById('preview-format-name').textContent = formatNames[format] || format.toUpperCase();

            // Get the optimized resume content
            let previewContent = currentOptimizedResumeText;
            if (!previewContent) {
                const optimizedResumeEl = document.getElementById('optimized-resume');
                previewContent = optimizedResumeEl.textContent || optimizedResumeEl.innerText;
            }

            // Format the preview
            const formattedPreview = formatResumeForDisplay(previewContent);

            // Display in modal
            document.getElementById('export-preview-content').innerHTML = formattedPreview;

            // Show the modal
            document.getElementById('export-preview-modal').style.display = 'flex';
        }

        function closeExportPreview() {
            document.getElementById('export-preview-modal').style.display = 'none';
        }

        async function proceedWithDownload() {
            // Close the preview modal
            closeExportPreview();

            // Proceed with actual download
            await actuallyDownloadResume();
        }

        async function downloadOptimizedResume() {
            // Download directly without showing preview
            if (!currentOptimizedResumeText || currentOptimizedResumeText.trim() === '') {
                showMessage('No optimized resume to download', 'error');
                return;
            }

            // Call the actual download function directly
            await actuallyDownloadResume();
        }

        async function actuallyDownloadResume() {
            // Get the original text content (not HTML formatted)
            const optimizedResumeEl = document.getElementById('optimized-resume');
            // Extract text from HTML or use textContent if available
            let optimizedResume = optimizedResumeEl.textContent || optimizedResumeEl.innerText;

            // If we have the original text stored, use that instead
            if (currentOptimizedResumeText) {
                optimizedResume = currentOptimizedResumeText;
            }

            if (!optimizedResume || optimizedResume.trim() === '') {
                showMessage('No optimized resume to download', 'error');
                return;
            }

            const format = document.getElementById('download-format').value;
            const formatNames = {
                'pdf': 'PDF',
                'docx': 'Word',
                'txt': 'Text'
            };

            try {
                showMessage(`Generating ${formatNames[format]} file...`, 'info');

                const response = await fetch('/api/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        resume_text: optimizedResume,
                        format: format,
                        filename: `optimized_resume.${format}`,
                        template: currentTemplate  // Pass selected template to download
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Download failed');
                }

                // Get the blob from response
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);

                // Create download link
                const a = document.createElement('a');
                a.href = url;
                a.download = `optimized_resume.${format}`;
                document.body.appendChild(a);
                a.click();

                // Cleanup
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showMessage(`${formatNames[format]} file downloaded successfully!`, 'success');
            } catch (error) {
                console.error('Download error:', error);
                showMessage('Error downloading file: ' + error.message, 'error');
            }
        }
    </script>
</body>

</html>